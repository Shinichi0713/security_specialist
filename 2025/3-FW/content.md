## FW

ファイアウォールの分類方法

| 種類                                 | 違い                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| パケットフィルタリング               | ルータ同様IPパケットを通過させるか、しないかを判断する                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| サーキットレベルゲートウェイ型       | [TCP](https://e-words.jp/w/TCP.html)や[UDP](https://e-words.jp/w/UDP.html)などの[トランスポート層](https://e-words.jp/w/%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B9%E3%83%9D%E3%83%BC%E3%83%88%E5%B1%A4.html)のレベルで内外の[通信](https://e-words.jp/w/%E9%80%9A%E4%BF%A1.html)を中継するもの。<br />サーキットレベルゲートウェイは[TCP](https://e-words.jp/w/TCP.html)（[Transmission Control Protocol](https://e-words.jp/w/TCP.html)）や[UDP](https://e-words.jp/w/UDP.html)（[User Datagram Protocol](https://e-words.jp/w/UDP.html)）による内外の[通信](https://e-words.jp/w/%E9%80%9A%E4%BF%A1.html)を中継するが、通過する[パケット](https://e-words.jp/w/%E3%83%91%E3%82%B1%E3%83%83%E3%83%88.html)の送信元や宛先を[動的](https://e-words.jp/w/%E5%8B%95%E7%9A%84.html)に書き換え、外部の[ホスト](https://e-words.jp/w/%E3%83%9B%E3%82%B9%E3%83%88.html)に対して自分が通信主体であるかのように見せかける。 |
| アプリケーションレベルゲートウェイ型 | アプリケーションゲートウェイ型ではアプリケーションレベルの制御が可能                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| パーソナルファイアウォール           | PCにインストールしてクライアント端末のみを守る                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| WAF                                  | WAFとは「Web Application Firewall（ウェブアプリケーションファイアウォール）」の略<br />Webアプリケーションへの不正なWeb攻撃を防ぐために開発された専用防御ツール<br />WAFがWebアプリケーション層でのセキュリティ対策であるのに対し、**ファイアウォールはネットワークレベルでのセキュリティ対策**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| L7ファイアウォール                   | アプリケーションレベルの動作を含む制御が可能<br />コンテンツフィルタリング機能<br />L7ファイアウォールは、マルウェア、フィッシング、DDoS攻撃などの高度な脅威を検出し、対策を講じることができます。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |

#### ゲートウェイ

ゲートウェイとは、異なるネットワーク間の通信を仲介するデバイスやソフトウェアのこと。

ネットワークやインターネットを接続するルータもゲートウェイの一種。

#### サーキットレベルGW

通信の内容は確認せず、接続のセッション情報をもとに通信の許可、拒否を制御する。

内部ネットワークと外部ネットワークの間でプロキシとして機能し、直接の通信を防ぐ。

#### ステートフルインスペクション

ファイアウォールを通過したパケットを管理して、正常な通信とみなせるもの(対応する戻りパケットか、パケットの順番、コネクションの状況など)だけを通過させる機能を持つファイアウォールのこと

#### L7ファイアウォールとアプリケーションレベルゲートウェイ型違い

* **動作の仕組み** ：
* **L7ファイアウォール** ：アプリケーション層でのトラフィックを詳細に検査し、特定のアプリケーションプロトコル（例：HTTP、HTTPS、FTPなど）に基づいてトラフィックをフィルタリングします。これにより、アプリケーションレベルでの不正なアクセスや攻撃を防ぎます。
* **アプリケーションレベルゲートウェイ** ：プロキシサーバーとして機能し、クライアントとサーバーの間に立って通信を仲介します。これにより、クライアントのIPアドレスを隠し、セキュリティを強化します。
* **検査の深さ** ：
* **L7ファイアウォール** ：トラフィックの内容を詳細に検査し、特定のアプリケーションプロトコルに基づいてトラフィックを許可または拒否します。コンテンツフィルタリングやユーザー認証などの高度な機能を提供します。
* **アプリケーションレベルゲートウェイ** ：トラフィックの内容を検査することは少なく、主に接続の確立と終了を監視し、セッション情報に基づいて通信を制御します。
* **用途** ：
* **L7ファイアウォール** ：高度な脅威検出やコンテンツフィルタリングが必要な環境で使用されます。例えば、企業のネットワークでのセキュリティ強化や、特定のアプリケーションの保護に適しています。
* **アプリケーションレベルゲートウェイ** ：プロキシサーバーとしての機能が求められる環境で使用されます。例えば、内部ネットワークのIPアドレスを隠すためや、特定のアプリケーションへのアクセスを制御するために使用されます。

#### ACL

ステートフルインスペクション型ファイアウォールのACL(セッション情報のみのFW)のフィルタリングルール

ルールの原則は以下の通り

1. 通常の通信は"ALL"or"ANY"で禁止
2. 許可する通信のみを許可

懸念として、社内のDMZのサーバに攻撃されて、踏み台にされた場合を想定。この場合でも、必要最小限の通信のみを許可する設定であれば、被害規模を抑えることが出来るようになる

#### 危険なポートをふさぐ

windowsで利用される135、137～139、445は利用がないならば原則禁止とすべき。

これまでwindowsのセキュリティホールをつくウィルスが多く発見されているため。

#### ファイアウィールの運用

- ファイアウォールを構築後は、実際の想定通りか確認のテストをする。特に仮想の攻撃を想定して、外部から行うようなテストをぺなとレーションテストと呼ぶ
- 運用のデータは基本的にログをとる

ログの確認の理由

1. ハッキングの初動を掴む
2. 長期的なハッキングを検出する
3. 日々と異なる動作を検出する

SIEMのようなログ可視化ツールを用いて、異常を早期に検出することを目指す

## IDSとIPS

ファイアウォールのみでは防ぐことが出来ない侵入への対抗措置としてIDSやIPSが用いられるケースがある。

#### IDS

IDSは侵入を検出するシステム。

ホスト型とネットワーク型の２種類に分類される。

動作は検知後にFWと連携してパケットをふさいだり、メールで通知したりという挙動を設定することが出来る。

| type                     | 特徴                                                                                                                                                                                                                         |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| HIDS<br />ホスト型       | 監視対象となるホストにインストールして、ホスト自体を監視する<br />①対象ホストのログファイルを監視<br />②ホストが受信する送受信パケットを監視<br />③ファイルの不正な改ざんを監視                                           |
| NIDS<br />ネットワーク型 | 監視対象のネットワークセグメントに設置し、ネットワーク内を流れるパケットを監視する<br />①プロミスキャス：自分宛でないパケットもすべて監視する<br />②ステルス：IPアドレスを振らない<br />③SW-HUB：モニタリングポートに接続 |

#### IPS

不正な侵入を監視・検知することが目的のIDSに対して、侵入される前に食い止めることが目的にしたシステムがIPS。

不正な通信と判断した通信を、自動的に遮断する機能を持ち、侵入そのものを阻止する。

インライン接続ですべての通信が通過するラインに設置すれば、最初の侵入を阻止することが可能となる。(IDSでは不可能なこと)

#### 検知の仕組み

不正アクセスを検知する仕組みには大別すると２種類

1. Misuse検知：不正アクセスを事前に定義しておく
2. Anomaly検知: 正常パターンを事前に定義しておく

##### Misuse検知

不正アクセスの攻撃パターンをDB化しておき、登録された不正アクセスパターンとの比較により、正常アクセスかどうかを判断する仕組み。

パターンマッチングと呼ばれる。

既知の不正アクセスには強いが、未知の不正アクセスには弱い

##### Anomaly検知

正常となるパターンを登録しておき、正常動作から外れた動作を行うものを異常として検知する方法。

シグネチャを用いた検知の仕組みと異なり、未知の異常にも対応できるのが長所。

## UTM

ファイアウォールにIDSやIPSが融合したデバイス

ファイアウォールを軸にして、VPN機能、IPS、アンチウイルス、コンテンツフィルタなどの機能を持たせることもあり、UTM自体に明確な定義はない

因みに、UTM製品を導入すると、コストや管理の手間が省けるというメリットがあるが、すべての通信のチェックを行うことはかなり負荷が大きい。→導入時は負荷とメリットを十分に考慮すると良い。

# 2nd
## ワーズ
### ファイアウォール
パケットフィルタリング

スタティック：
データの送信元や宛先などの情報が記録された部分があります。 スタティックパケットフィルタリングのファイアウォールは、 主にパケットのヘッダを参照して、アクセスの許可や禁止を決定します。

ダイナミック：
ダイナミックなパケットフィルタの場合、クライアントとサーバーのやりとりをファイアウォールが記憶し、 動的にポートを開け閉めします。

例えば、スタティックなパケットフィルタの場合、外部と内部の双方向通信を行うためには 外部→内部、内部→外部の双方の通信が明示的に許可されていなくてはなりません。


ステートフルパケットインスペクション：
このファイアウォールはコンテキストの中でパケットを判断します。 コンテキストとは、文脈という意味で、この場合はプログラムが処理内容を置かれた状態や状況、 与えられた条件から判断するという意味です。

ステートフルパケットインスペクションは、 コンテキストからパケットが正当な手順を踏んで送信されたものであるかどうかを見抜き、 不正な偽装パケットを検出することが可能です。

アプリケーション：
プロキシとは代理という意味で、ファイアウォールが内部コンピュータの代わりに外部サーバーにアクセスし、 やりとりした通信を内部に応答します。

内部ネットワークは直接外部と接触しなくて済むので、外部の攻撃から保護されます。

外部サーバーから見たパケットのやりとりの相手は、ファイアウォールマシンとなり、 内部ネットワークは完全に隠されます。

このタイプのファイアウォールは、パケットを全て参照するため、 ユーザー単位でのアクセス制限や、内容によるフィルタリングなど、細部まで確認することが出来ます。

### ゲートウェイ型
- パケットフィルタリング型のファイアウォールにポート制御機能を加えたもの。
- トランスポート層のレベルで通信を監視する。
- コネクション単位で通信許可して良いかを判断する。
- 送信元IPアドレスのなりすましにも対応可能

### アプリケーションゲートウェイ
アプリケーションゲートウェイ型の場合、内部コンピュータの代わりにファイアウォールが外部へアクセスします。ファイアウォールは外部サイトへアクセスしたのち、通信の内容を内部コンピュータへ送ってくれるため、クライアントから直接外部へ接触することはありません。
このようにファイアウォールが代理で外部にアクセスしてくれることから、アプリケーションゲートウェイ型はプロキシ型とも呼ばれます。
アプリケーションゲートウェイはプロキシ型のファイアウォール。

通信内容はアプリケーション層で解析して、不正なアクセスや許可されていない通信を遮断する。
通信の匿名かやアクセス制御が実施出来る。

### WAF
HTTP/HTTPS通信を解析し、Webアプリケーションへの攻撃を検知・防御する。
webアプリケーションの脆弱性を狙った攻撃に特化して対策。

Webアプリケーションへの攻撃防御やサイト改ざんの防止が可能。

### L7ファイアウォール

IPアドレスとTCPポート番号を見て通過させるかを判断させるパケットフィルタリングのFWに対して、アプリケーションレベルで判断するFWが高機能化したもの。

アプリケーションレベルをチェックするFWに関しては、CPUの高性能化に合わせて高機能化。
FWが普及し始めた90年代にはアプリケーションGWと呼ばれていた。

## ACL
FWに関するステートフルパケットインスペクション型FWのACLの定義＝フィルタリングルールに関するものが出題される。

デフォルト禁止

通常アクセスコントロールの設定では、デフォルト全部禁止が標準。
このケースは記述場所を最後にする。

各通信
社内LANやDMZへのアクセス、社内LANやDMZからのアクセスはいずれも必要最小限とする。

その他全ての通信を禁止にするのが原則。

DMZから社内LANへのアクセスを必要最小限とするのは、DMZのサーバが攻撃者に則られた場合、踏み台にして社内LANにアクセスされるケースを防止するため。

### ACLの対策

__危険なポートをふさぐ__

135、137～139、445は特に利用しないならば原則双方向禁止することを検討する。

双方向通信はWindowsのセキュリティホールをつくウィルスや攻撃が数多く発見される。

__フィルタリングルールの問題点を指摘させる__

どこが問題かを指摘する設問

### ファイアウォールの運用

FWを構築した後は、設計したポリシと同じ働きをするかどうかの確認テストを実施する。

仮想的攻撃を外部から行うテストをペネトレーションテストと呼ぶ。

__パケットフィルリング型のファイアウォールでは防げない攻撃__

1. 一部のDoS
2. セキュリティホールをついてる正常なパケット
3. Eメールに添付されるワーム
4. 悪意あるサイトへのアクセス

__パケットフィルタリング__

ネットワーク層やトランスポート層で動作しパケットごとに通信を制御するFW。

- IPアドレスによる制御
- ポート番号による制御
- プロトコルによる制御
- パケット単位でのフィルタリング
- ステートレスな動作(基本1つ１つのパケットを独立して判断し、セッションや通信の流れは追跡しない)

## IDS / IPS
FWだｋでは防ぎきれない侵入への対抗措置として用いられるIDSやIPS。

### IDS
侵入を検知するシステムでホスト型とネットワーク型の2タイプに分けられる。

親友を検知するとログに記録したり、アナウンスしたりする。
また、ＦＷと連携して後続するパケットを遮断させるなど、事後対応させるものがあるが、最初のパケットは通過させることになる。→被害を受ける可能性は残る。

ホスト型IDS

監視対象となるホストにインストールし、ホスト自身を監視するタイプのIDS。
監視方法はログを監視、送受信パケットを監視、ファイルの改ざんを監視

ネットワーク型IDS

監視対象のネットワークセグメントに設置し、ネットワーク上を流れるパケットを監視する。
ネットワーク上のパケットを監視する機能には以下が存在
- プロミスキャスモード
- ステルスモード
- SW-HUBにはモニタリングポートに接続

### IPS

不正な親友を監視・検知することが目的のIDSに対して、侵入される前に防ぐことを目的にするシステムがIPS。

IDSを発展させた形で、不正な通信を自動的に遮断する機能を持ち、インライン接続で全ての通信が通る場所に設置することで、最初の通信を阻止することが可能となる。

### 検知の仕組み

__Misuse検知__

不正アクセスの攻撃パターンをDB化しておき、不正亜k末すパターンとの比較によって、正常アクセスかを判断する仕組み。
登録データベースをシグネチャという→シグネチャ型と呼ばれる。

__Anomaly検知__

正常のパターンを登録しておき、正常動作から離れた動作を異常として検知する方法。
誤検知が多くなる可能性がある。

## UTM
FWはIDSやIPS、ウィルス対策ソフトなどを取り込んで統合脅威管理ソフトUTMとして多機能化された。

機能はおおよそ、
自宅や外出先から内部ネットワークに安全にアクセスできるようにVPN機能、アンチウィルス機能、メールフィルタリング機能、コンテンツフィルタリング機能などが搭載される。

自宅や外出先から内部ネットワークに安全にアクセスできるようにVPN機能をもたせたりバラバラ。

__代表機能__

1. FW
2. VPN
3. IPS/IDS
4. アンチウィリス
5. サンドボックス
6. アンチスパム
7. メールフィルタリング
8. コンテンツフィルタリング




