## サーバーセキュリティ範囲

サーバーセキュリティ、プロキシサーバーセキュリティ、WEBサーバー、DNSサーバー、DHCPサーバーなどの仕組み

## サーバー要塞化

様々な脅威への対策を行うことを要塞化という。

1. セキュリティ対策を行った最新バージョンの維持
2. デフォルト状態からの変更
3. 適切なアクセス権の設定
4. ログの設定

デフォルト設定は、広く知られた状態なので危険。

最新のパッチが公開されても以下のような手順で適用する

- OSベンダがセキュリティパッチを公開した場合、リリースノートを確認する
- パッチ担当者は、検証LANのPCに適用し、PC動作に問題ないことを確認する
- パッチに不具合の情報が公開されてないことを確認の上で、セキュリティパッチを配信サーバーに置く
- PCは適用すべきパッチがあるかを常時確認するように設定されてる→定期的な確認を行う

#### EPP・EDRの導入

エンドポイント＝ネットワークの終端のセキュリティ強化をすることが注目されている。


## プロキシサーバー/IAP

プロキシサーバーとはクライアント端末がインターネット上のWEBサーバーにアクセスする際に、当該端末の代わりに代理で応答するサーバーのこと。

通常はDMZに配置される。

アクセスしたWEBページをキャッシュする機能をもつため、ネットワーク負荷低減の役割を持つ、セキュリティ向上のため設置される。

1. 端末の隠蔽
   端末とインターネット上のWEBサーバーが通信している場合でも、プロキシサーバーが両社の間で直接のやり取りをしているため、社内LAN内の端末を隠蔽することが出来る。これにより、クライアント端末自体の安全性を向上することができる。
2. クライアントからのアクセス集中制御
   ファイアウォールで、プロキシサーバー以外の端末のインターネット接続を遮断することで、外部との通信をすべてプロキシサーバー経由に集約できる。→アクセスログのチェックが一元化、URLフィルタリングやアンチウィルスの機能を持たせることで、セキュリティ向上が期待できる
3. 標的型攻撃の出口対策
   標的型攻撃では標的となった端末がマルウェアに感染すると、当該端末がC&Cサーバーに対してコネクトバック通信を試みる。この時に、ファイアウォールで直接の接続を禁止していると、C&Cサーバーとの通信をトリガーとする被害を抑えることが出来る
4. 認証機能
   Internetと接続時に認証機能がついていれば、接続できる端末に制限をかけることが出来る。プロキシを経由するタイプのマルウェアを抑制する効果も期待できる。
5. IAP
   クライアントとアプリケーション間の通信を仲介するプロキシ、ユーザー認証し、ユーザーに許可されているアプリケーションだけを利用させるソリューションをIAPと呼ぶ。防御対象のアプリケーションはオンプレ、クラウド両方。オンプレでもクラウドでもコネクタというサーバーを設置し、IAPはコネクタと通信を行い、コネクタがアプリケーションと通信する。

## WEBサーバーのセキュリティ

WEBサーバーからWEBサーバーに送るデータをリクエスト、サーバーからブラウザに送られるデータはレスポンス。

#### GETメソッド

GetメソッドはブラウザからWEBサーバーにリクエストを送信するときに使われるメソッド。

セキュリティ面では不都合な点あり。フォームより入力したデータは、URL後半のクエリとして返されることになる。ログにも残るし、リファラでリンク先にも送信される→漏洩の可能性がある。

#### POSTメソッド

入力情報をサーバーに送信する際にリクエストボディを使って送信するため、少しは安全性が改善することが出来る。

#### Cookieを利用したセッション管理

HTTP通信は、ステートレスな通信＝リクエストとレスポンスのやり取りで完結する通信。

WEBの通販サイトなどのような一連の画面遷移が必要な場合、セッション管理が必要となる。

セッション管理の代表例がCookieを用いる方法。

Cookieとはサーバとクライアントでやり取りされるテキストデータ。

WEBサーバーからのHTTPレスポンスに①"Set-Cookie"でCookieを使用することを宣言、②セッションIDを記述、しておくと、ブラウザはCookieの値を保持して、アクセスごとのCookieのセッションIDを付けてサーバーに送付するようになる。→これにより連続性のある処理が出来るようになる。

Cookieには属性を指定することが出来る。推奨される設定は以下の通り

1. domain
   domain=itec.co.jpのように指定→指定したドメインとサブドメインのみにcookieを送信するようになる
2. expires
   有効期限。日時で指定。ほかにMax-Ageで指定が可能
3. secure
   設定すると、http通信で保護されているときしかcookieを送信しなくなる
4. HttpOnly
   設定すると、cookieへのアクセスがhttpからのみになる。→javascript等のスクリプトからアクセスできなくなる。このためXSS脆弱性があってもcookieから読み取られなくなる。

#### 脅威
##### セッションハイジャック
HTTPセッション管理ではCookieを用いる手法が一般的となっている。
そのほかの方法には以下のようなものもある。
- クエリストリングにセッションIDを含める方法
- hiddenフィールドにセッションIDを含める方法
上記のセッションIDが処理の連続性を保つ情報となる→盗聴or推測されるとなりすましされる。
__対応法__
- cookieの取り扱いを安全にする
- 推測しづらいセッションIDにする
- 必要最低限のdomainと有効期限を設定する。httponlyもできる限り設定

##### セッションフィクセーション
攻撃手順は以下の通り
1. 攻撃者が、正規のWEBサイトよりセッションIDを取得する
2. 別の利用者に対して、セッションIDを送り込み、正規のWEBサイトにログインする
3. ログイン状態になったら、攻撃者が利用者になりすます
※上記攻撃は、ブラウザにcookieモンスターバグという脆弱性がある場合や、HTTPヘッダインジェクションの脆弱性がある場合、攻撃者の用意したcookieを受け入れてしまい攻撃が成功する

__対応法__
認証が終わった後、WEBサイトが新規のセッションIDを発行する。

##### HTTPヘッダインジェクション
HTTPリクエストのクエリストリングに、不正コードを挿入して、悪意あるスクリプトを埋め込んだHTTPレスポンスを作成して、ブラウザに攻撃者の悪意を持つフォームを表示させるなどのHTTPヘッダに悪意あるコードを混入させる攻撃を、HTTPヘッダインジェクションと呼ぶ。
HTTPヘッダインジェクションは、ユーザーが入力したデータを適切に検証せずにHTTPレスポンスヘッダに反映させることで発生する脆弱性。
例. 以下サイトにアクセスする
```http
http://example.com/redirect.php?to=home
```
このサイトに対して、以下のようなクエリストリングを追加する
```http
http://example.com/redirect.php?to=home%0d%0aSet-Cookie:%20sessionId=abcd1234
```
このクエリストリングの%0d%0aは、CRLF（キャリッジリターンとラインフィード）を表し、HTTPヘッダの改行を意味します。このように改行を挿入することで、新しいHTTPヘッダを追加することができます。この例では、Set-Cookie: sessionId=abcd1234という新しいヘッダが追加され、セッションIDが固定されてしまいます。

このような攻撃を防ぐためには、ユーザー入力を適切にサニタイズし、改行コードを含む不正なデータを除去することが重要です。

%0d%0aが2回続くと、空白行が２個あることになる→ヘッダとボディを分けることになる


## LDAPサーバー

LDAP（ディレクトリサービスとやり取りするときに使うお約束事）を使ってやりとりできる、ディレクトリサービス

（ネットワークの世界における「俺がいろんな情報をまとめて管理しているから、なにか困ったことがあったら俺に聞いてこい」型サービス）を提供するコンピュータのこと

#### ディレクトリサービス

ネットワーク上でさまざまな情報を一元管理し、必要な情報を提供するサービス

例えば、プリンタの場所やユーザーの認証情報などを管理します。ディレクトリサービスを提供するコンピュータは「サーバ」と呼ばれ、他のコンピュータが必要な情報を問い合わせると、その情報を提供します

ディレクトリサービスの例としては、WindowsのActive Directoryが有名です。ディレクトリサービスを利用する際には、通信プロトコルとしてLDAP（Lightweight Directory Access Protocol）がよく使われます



#### リファラ

[Webブラウザ](https://e-words.jp/w/Web%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6.html)が[Webサーバ](https://e-words.jp/w/Web%E3%82%B5%E3%83%BC%E3%83%90.html)への[HTTPリクエスト](https://e-words.jp/w/HTTP%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88.html)送信時に「Referer:」[ヘッダ](https://e-words.jp/w/%E3%83%98%E3%83%83%E3%83%80.html)で申告する[情報](https://e-words.jp/w/%E6%83%85%E5%A0%B1.html)で、これをたどっていくと閲覧者がどこの[サイト](https://e-words.jp/w/%E3%82%B5%E3%82%A4%E3%83%88.html)から[訪問](https://e-words.jp/w/%E3%83%93%E3%82%B8%E3%83%83%E3%83%88.html)したのか、また、[サイト](https://e-words.jp/w/%E3%82%B5%E3%82%A4%E3%83%88.html)内でどのような軌跡をたどったのかなどを調べることができる。


##### Refererヘッダ

[Webブラウザ](https://e-words.jp/w/Web%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6.html)はページの[リンク](https://e-words.jp/w/%E3%83%AA%E3%83%B3%E3%82%AF.html)を[クリック](https://e-words.jp/w/%E3%82%AF%E3%83%AA%E3%83%83%E3%82%AF.html)あるいは[タップ](https://e-words.jp/w/%E3%82%BF%E3%83%83%E3%83%97.html)して次のページに移る際に、遷移元のページの[URL](https://e-words.jp/w/URL.html)をReferer[ヘッダ](https://e-words.jp/w/%E3%83%98%E3%83%83%E3%83%80.html)として[HTTPリクエストヘッダ](https://e-words.jp/w/HTTP%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%98%E3%83%83%E3%83%80.html)中に記載することになっている。記載の可否や内容はReferer-Policy[ヘッダ](https://e-words.jp/w/%E3%83%98%E3%83%83%E3%83%80.html)や[HTMLファイル](https://e-words.jp/w/HTML%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB.html)中の[metaタグ](https://e-words.jp/w/meta%E8%A6%81%E7%B4%A0.html)である程度指定できる。

以前は[パス](https://e-words.jp/w/%E3%83%91%E3%82%B9.html)や[クエリ](https://e-words.jp/w/%E3%82%AF%E3%82%A8%E3%83%AA.html)など完全な[URL](https://e-words.jp/w/URL.html)を記録するのが原則だったが、[利用者](https://e-words.jp/w/%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC.html)の[ネット](https://e-words.jp/w/%E3%83%8D%E3%83%83%E3%83%88.html)上での活動履歴を[サイト](https://e-words.jp/w/%E3%82%B5%E3%82%A4%E3%83%88.html)運営者に知らせることになるため、近年では異なる[ドメイン](https://e-words.jp/w/%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3.html)間の遷移では[ドメイン](https://e-words.jp/w/%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3.html)名部分しか送らない（「[https:](https://e-words.jp/w/HTTPS.html)//[example.jp](https://e-words.jp/w/example.com.html)/[dir](https://e-words.jp/w/dir%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89.html)/page.[html](https://e-words.jp/w/HTML.html)?q=[query](https://e-words.jp/w/%E3%82%AF%E3%82%A8%E3%83%AA.html)」→「[https:](https://e-words.jp/w/HTTPS.html)//exmaple[.jp](https://e-words.jp/w/JP%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3.html)/」）よう変更されている。


