## サーバーセキュリティ範囲

サーバーセキュリティ、プロキシサーバーセキュリティ、WEBサーバー、DNSサーバー、DHCPサーバーなどの仕組み

## サーバー要塞化

様々な脅威への対策を行うことを要塞化という。

1. セキュリティ対策を行った最新バージョンの維持
2. デフォルト状態からの変更
3. 適切なアクセス権の設定
4. ログの設定

デフォルト設定は、広く知られた状態なので危険。

最新のパッチが公開されても以下のような手順で適用する

- OSベンダがセキュリティパッチを公開した場合、リリースノートを確認する
- パッチ担当者は、検証LANのPCに適用し、PC動作に問題ないことを確認する
- パッチに不具合の情報が公開されてないことを確認の上で、セキュリティパッチを配信サーバーに置く
- PCは適用すべきパッチがあるかを常時確認するように設定されてる→定期的な確認を行う

#### EPP・EDRの導入

エンドポイント＝ネットワークの終端のセキュリティ強化をすることが注目されている。


## プロキシサーバー/IAP

プロキシサーバーとはクライアント端末がインターネット上のWEBサーバーにアクセスする際に、当該端末の代わりに代理で応答するサーバーのこと。

通常はDMZに配置される。

アクセスしたWEBページをキャッシュする機能をもつため、ネットワーク負荷低減の役割を持つ、セキュリティ向上のため設置される。

1. 端末の隠蔽
   端末とインターネット上のWEBサーバーが通信している場合でも、プロキシサーバーが両社の間で直接のやり取りをしているため、社内LAN内の端末を隠蔽することが出来る。これにより、クライアント端末自体の安全性を向上することができる。
2. クライアントからのアクセス集中制御
   ファイアウォールで、プロキシサーバー以外の端末のインターネット接続を遮断することで、外部との通信をすべてプロキシサーバー経由に集約できる。→アクセスログのチェックが一元化、URLフィルタリングやアンチウィルスの機能を持たせることで、セキュリティ向上が期待できる
3. 標的型攻撃の出口対策
   標的型攻撃では標的となった端末がマルウェアに感染すると、当該端末がC&Cサーバーに対してコネクトバック通信を試みる。この時に、ファイアウォールで直接の接続を禁止していると、C&Cサーバーとの通信をトリガーとする被害を抑えることが出来る
4. 認証機能
   Internetと接続時に認証機能がついていれば、接続できる端末に制限をかけることが出来る。プロキシを経由するタイプのマルウェアを抑制する効果も期待できる。
5. IAP
   クライアントとアプリケーション間の通信を仲介するプロキシ、ユーザー認証し、ユーザーに許可されているアプリケーションだけを利用させるソリューションをIAPと呼ぶ。防御対象のアプリケーションはオンプレ、クラウド両方。オンプレでもクラウドでもコネクタというサーバーを設置し、IAPはコネクタと通信を行い、コネクタがアプリケーションと通信する。

## WEBサーバーのセキュリティ

WEBサーバーからWEBサーバーに送るデータをリクエスト、サーバーからブラウザに送られるデータはレスポンス。

#### GETメソッド

GetメソッドはブラウザからWEBサーバーにリクエストを送信するときに使われるメソッド。

セキュリティ面では不都合な点あり。フォームより入力したデータは、URL後半のクエリとして返されることになる。ログにも残るし、リファラでリンク先にも送信される→漏洩の可能性がある。

#### POSTメソッド

入力情報をサーバーに送信する際にリクエストボディを使って送信するため、少しは安全性が改善することが出来る。

#### Cookieを利用したセッション管理

HTTP通信は、ステートレスな通信＝リクエストとレスポンスのやり取りで完結する通信。

WEBの通販サイトなどのような一連の画面遷移が必要な場合、セッション管理が必要となる。

セッション管理の代表例がCookieを用いる方法。

Cookieとはサーバとクライアントでやり取りされるテキストデータ。

WEBサーバーからのHTTPレスポンスに①"Set-Cookie"でCookieを使用することを宣言、②セッションIDを記述、しておくと、ブラウザはCookieの値を保持して、アクセスごとのCookieのセッションIDを付けてサーバーに送付するようになる。→これにより連続性のある処理が出来るようになる。

Cookieには属性を指定することが出来る。推奨される設定は以下の通り

1. domain
   domain=itec.co.jpのように指定→指定したドメインとサブドメインのみにcookieを送信するようになる
2. expires
   有効期限。日時で指定。ほかにMax-Ageで指定が可能
3. secure
   設定すると、http通信で保護されているときしかcookieを送信しなくなる
4. HttpOnly
   設定すると、cookieへのアクセスがhttpからのみになる。→javascript等のスクリプトからアクセスできなくなる。このためXSS脆弱性があってもcookieから読み取られなくなる。

#### 脅威
##### セッションハイジャック
HTTPセッション管理ではCookieを用いる手法が一般的となっている。
そのほかの方法には以下のようなものもある。
- クエリストリングにセッションIDを含める方法
- hiddenフィールドにセッションIDを含める方法
上記のセッションIDが処理の連続性を保つ情報となる→盗聴or推測されるとなりすましされる。
__対応法__
- cookieの取り扱いを安全にする
- 推測しづらいセッションIDにする
- 必要最低限のdomainと有効期限を設定する。httponlyもできる限り設定

##### セッションフィクセーション
攻撃手順は以下の通り
1. 攻撃者が、正規のWEBサイトよりセッションIDを取得する
2. 別の利用者に対して、セッションIDを送り込み、正規のWEBサイトにログインする
3. ログイン状態になったら、攻撃者が利用者になりすます
※上記攻撃は、ブラウザにcookieモンスターバグという脆弱性がある場合や、HTTPヘッダインジェクションの脆弱性がある場合、攻撃者の用意したcookieを受け入れてしまい攻撃が成功する

__対応法__
認証が終わった後、WEBサイトが新規のセッションIDを発行する。

##### HTTPヘッダインジェクション
HTTPリクエストのクエリストリングに、不正コードを挿入して、悪意あるスクリプトを埋め込んだHTTPレスポンスを作成して、ブラウザに攻撃者の悪意を持つフォームを表示させるなどのHTTPヘッダに悪意あるコードを混入させる攻撃を、HTTPヘッダインジェクションと呼ぶ。
HTTPヘッダインジェクションは、ユーザーが入力したデータを適切に検証せずにHTTPレスポンスヘッダに反映させることで発生する脆弱性。
例. 以下サイトにアクセスする
```http
http://example.com/redirect.php?to=home
```
このサイトに対して、以下のようなクエリストリングを追加する
```http
http://example.com/redirect.php?to=home%0d%0aSet-Cookie:%20sessionId=abcd1234
```
このクエリストリングの%0d%0aは、CRLF（キャリッジリターンとラインフィード）を表し、HTTPヘッダの改行を意味します。このように改行を挿入することで、新しいHTTPヘッダを追加することができます。この例では、Set-Cookie: sessionId=abcd1234という新しいヘッダが追加され、セッションIDが固定されてしまいます。

このような攻撃を防ぐためには、ユーザー入力を適切にサニタイズし、改行コードを含む不正なデータを除去することが重要です。

%0d%0aが2回続くと、空白行が２個あることになる→ヘッダとボディを分けることになる

###### 重要ファイルを公開ディレクトリにおかない
検索エンジンにひっかかったり、ディレクトリトラバーサル攻撃により重要ファイルが流出する可能性がある

###### HTTP認証
HTTPプロトコルに標準で用意されている認証方式＝HTTP認証をもちいることがある
- Basic認証
  入力したIDとPWを平文で送出することになるため危険
- Digest認証
　Basic認証の弱点を改善した手法で、IDとPWをハッシュ化して送出する
　1. サーバーでランダムな文字列(nonce)を生成し、クライアントに送信
　2. ユーザがログインIDとPWを入力
　3. PWにnonceを付与し、ハッシュ化したデータをサーバーに送信
　4. サーバー側で受信データを確認する
　※nonce：暗号や認証プロトコルで仕様される使い捨てのランダムな文字列のこと

##### オープンリダイレクト対策
次のようなURLを実行し、システムにアクセスした際に別のサイトに異動させる機能。
Webアプリケーションのリダイレクト機能を悪用して、ユーザーを攻撃者が用意したページに誘導する脆弱性。
```
https://example.com/redirect?url=https://malicious-site.com
```
この場合、この場合、https://example.comのサブドメインに見せかけたhttps://example.com.evil.comにリダイレクト
```
https://example.com/redirect?url=https://example.com.evil.com
```
##### CORS
CORS（Cross-Origin Resource Sharing）は、異なるオリジン間でリソースを共有するための仕組みです。通常、ウェブブラウザはセキュリティ上の理由から、同一オリジンポリシー（Same-Origin Policy）を適用し、異なるオリジンからのリクエストを制限します。しかし、CORSを使用することで、特定の条件下で異なるオリジンからのリクエストを許可することができる。

__CORSの仕組み__
リクエスト送信: クライアント（ブラウザ）がサーバにリクエストを送信します。
サーバの応答: サーバは特定のHTTPヘッダー（例: Access-Control-Allow-Origin）を使用して、どのオリジンからのリクエストを許可するかを指定します。
ブラウザの確認: ブラウザはサーバの応答を確認し、許可されたオリジンからのリクエストであればリソースにアクセスします。
※サーバーがアクセスして良いオリジンを指定する仕組み→ブラウザが変はサイトからのレスポンスを受けることがなくなる仕組み

##### WAF
Webaアプリケーションへの攻撃を防ぐために、サーバー側に導入されるものがWAF。
問題ある通信パターンを遮断や無害化。
正常な通信のみを通過させる。
PCI DSSでは、一般公開されているWebアプリケーションは、定期的な脆弱性への対応か、WAFの導入をしなければならないと定めている。

例:aws waf設定例
```
{
  "Name": "BlockSpecificIP",
  "Priority": 1,
  "Action": {
    "Block": {}
  },
  "Statement": {
    "IPSetReferenceStatement": {
      "ARN": "arn:aws:wafv2:region:account-id:ipset/BlockIPSet"
    }
  },
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "BlockSpecificIP"
  }
}
```

## DNSサーバーのセキュリティ
ドメイン名からIPアドレスの対応関係を管理するためのサーバー。
２種類存在する。
1. ドメイン名とIPアドレスの対応関係を管理する権威DNSサーバー
2. 端末からの問い合わせに解答するキャッシュDNSサーバー
#### 名前解決手順
1. クライアントPCのリゾルバがFQDNをキャッシュサーバーに対して名前解決の問い合わせを行う
2. キャッシュサーバーはルートDNSサーバーから順番にFQDNの構成名について問い合わせを行う
3. 最終的にFQDNの権威DNSサーバーが対応するIPアドレスを返す
#### 脅威
CDNサーバー：オリジナルサーバーの代わりにアクセスを受け付けてクレスキャッシュサーバー配置させたネットワーク。負荷分散やレイテンシの平準化のために利用する。

| 攻撃名 | 攻撃内容 |
| ------- | ---------------------------------------------------------------------- |
| DNSキャッシュポイズニング | キャッシュDNSサーバに不正な情報を送信して、本来とは異なるwebサーバーに誘導させる攻撃 |
| DNSリフレクション | DNSサーバーの再帰的な問い合わせを悪用したサービス不要攻撃。インターネットからアクセスできるキャッシュサーバーに送信元IPアドレスを攻撃対象のOP青dレスに偽装したDNS問い合わせを行う。するとDNS応答は攻撃対象のサーバーに送信され、攻撃対象サーバーのリソースを消費することになる |
| サブドメインステークオーバー | CDNサービスやクラウドサービスを利用する際に、CNAMEレコードを使って、サブドメインを使って、攻撃者が用意した罠サイトに誘導する攻撃 |

#### セキュリティ対策
1. 不要なレコードを残さない
   CDNやクラウドサービスを停止した場合、CNAMEやAレコードは削除する
2. オープンリゾルバの禁止
   オープンリゾルバを禁止する。
   具体的には権威DNSサーバーと、キャッシュDNSサーバーを分類して、キャッシュサーバーにインターネットから問い合わせできないようにして、悪用されないようにする。
   ※キャッシュサーバーにはコンテンツ機能を持たせない。
   ※キャッシュサーバーに適切なアクセスコントロールを施して、インターネットからのアクセスを禁止する
3. ソースポート乱打米ゼーション
   キャッシュDNSサーバーでは、権威DNSサーバーに遠い合わせる場合、IDやポート番号を保持して起き、正しい応答かどうかを判断するようにする。この時にポート番号をランダム化して、攻撃者が推測・悪用できないようにする
4. DNSSEC
   DNSのセキュリティを強化するための拡張しよう。DNSレコードにデジタル署名を施すことで、正当性を証明する。
   正当性のチェックや改ざんの有無を検出することが可能となるが、仕組みが大がかりになるのが難点


##### CNAMEレコード
CNAMEレコード（Canonical Nameレコード）は、DNS（Domain Name System）で使用されるレコードの一種で、あるドメイン名を別のドメイン名に関連付けるために使用されます。これにより、ドメイン名のエイリアス（別名）を作成することができます。

例. www.example.comにアクセスすると、実際にはexample.comにアクセスすることになります
```
www.example.com. IN CNAME example.com.
```
※CNAMEレコードは他のDNSレコード（例えば、MXレコード）と同じドメイン名に対して同時に使用することはできません。


## DHCPサーバー
端末に固定のIPアドレスを設定するのではなく、端末が起動の度にIPアドレスを自動的に割り当てるというプロトコルがDHCP。
割り当てるサーバーをDHCPサーバー。割り当てられるクライアントをDHCPクライアントと呼ぶ。
通信はUDPより行われる。
主要なOSやルータにはDHCPサーバーの機能が搭載されている→ルータ以上のデバイスを設定すれば、基本配下のネットワークの端末は勝手にIPアドレス降られるような設定ができる。

#### ユニキャストアドレス
ユニキャストアドレスとは、ネットワーク通信において、特定の1つの受信者にデータを送信するためのアドレスです。具体的には、IPアドレスやMACアドレスがこれに該当します。

__ユニキャストアドレスの特徴__
一対一の通信: ユニキャストアドレスは、送信者が特定の1つの受信者に対してデータを送信するために使用されます。
例: 通常のウェブブラウジングやメールの送受信など、特定の相手にデータを送る際に使用されます。

#### リレーエージェント
同一サブネット内にDHCPサーバーが存在しない場合、ルータにリレーエージェント機能があれば、別のサブネットのDHCPサーバーとやり取りすることができる
ルータはブロードキャストアドレスをユニキャストアドレスに変換ｓいて、別サブネットのDHCPサーバーにDHCPディスカバーメッセージを送信する。

#### IPアドレス発行まで
1. クライアント端末がDHCP Discoverをブロードキャストアドレスで送信
2. DHCPサーバーがDHCP OFFERを送信。プールからIPアドレスを提案する。
3. クライアントが早い者勝ちで提案された内容に対して、DHCP REQUESTを返す
4. DHCPサーバーがDHCP Packを送信すればIPアドレスの設定が完了


## LDAPサーバー

LDAP（ディレクトリサービスとやり取りするときに使うお約束事）を使ってやりとりできる、ディレクトリサービス

（ネットワークの世界における「俺がいろんな情報をまとめて管理しているから、なにか困ったことがあったら俺に聞いてこい」型サービス）を提供するコンピュータのこと

#### ディレクトリサービス

ネットワーク上でさまざまな情報を一元管理し、必要な情報を提供するサービス

例えば、プリンタの場所やユーザーの認証情報などを管理します。ディレクトリサービスを提供するコンピュータは「サーバ」と呼ばれ、他のコンピュータが必要な情報を問い合わせると、その情報を提供します

ディレクトリサービスの例としては、WindowsのActive Directoryが有名です。ディレクトリサービスを利用する際には、通信プロトコルとしてLDAP（Lightweight Directory Access Protocol）がよく使われます



#### リファラ

[Webブラウザ](https://e-words.jp/w/Web%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6.html)が[Webサーバ](https://e-words.jp/w/Web%E3%82%B5%E3%83%BC%E3%83%90.html)への[HTTPリクエスト](https://e-words.jp/w/HTTP%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88.html)送信時に「Referer:」[ヘッダ](https://e-words.jp/w/%E3%83%98%E3%83%83%E3%83%80.html)で申告する[情報](https://e-words.jp/w/%E6%83%85%E5%A0%B1.html)で、これをたどっていくと閲覧者がどこの[サイト](https://e-words.jp/w/%E3%82%B5%E3%82%A4%E3%83%88.html)から[訪問](https://e-words.jp/w/%E3%83%93%E3%82%B8%E3%83%83%E3%83%88.html)したのか、また、[サイト](https://e-words.jp/w/%E3%82%B5%E3%82%A4%E3%83%88.html)内でどのような軌跡をたどったのかなどを調べることができる。


##### Refererヘッダ

[Webブラウザ](https://e-words.jp/w/Web%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6.html)はページの[リンク](https://e-words.jp/w/%E3%83%AA%E3%83%B3%E3%82%AF.html)を[クリック](https://e-words.jp/w/%E3%82%AF%E3%83%AA%E3%83%83%E3%82%AF.html)あるいは[タップ](https://e-words.jp/w/%E3%82%BF%E3%83%83%E3%83%97.html)して次のページに移る際に、遷移元のページの[URL](https://e-words.jp/w/URL.html)をReferer[ヘッダ](https://e-words.jp/w/%E3%83%98%E3%83%83%E3%83%80.html)として[HTTPリクエストヘッダ](https://e-words.jp/w/HTTP%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%98%E3%83%83%E3%83%80.html)中に記載することになっている。記載の可否や内容はReferer-Policy[ヘッダ](https://e-words.jp/w/%E3%83%98%E3%83%83%E3%83%80.html)や[HTMLファイル](https://e-words.jp/w/HTML%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB.html)中の[metaタグ](https://e-words.jp/w/meta%E8%A6%81%E7%B4%A0.html)である程度指定できる。

以前は[パス](https://e-words.jp/w/%E3%83%91%E3%82%B9.html)や[クエリ](https://e-words.jp/w/%E3%82%AF%E3%82%A8%E3%83%AA.html)など完全な[URL](https://e-words.jp/w/URL.html)を記録するのが原則だったが、[利用者](https://e-words.jp/w/%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC.html)の[ネット](https://e-words.jp/w/%E3%83%8D%E3%83%83%E3%83%88.html)上での活動履歴を[サイト](https://e-words.jp/w/%E3%82%B5%E3%82%A4%E3%83%88.html)運営者に知らせることになるため、近年では異なる[ドメイン](https://e-words.jp/w/%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3.html)間の遷移では[ドメイン](https://e-words.jp/w/%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3.html)名部分しか送らない（「[https:](https://e-words.jp/w/HTTPS.html)//[example.jp](https://e-words.jp/w/example.com.html)/[dir](https://e-words.jp/w/dir%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89.html)/page.[html](https://e-words.jp/w/HTML.html)?q=[query](https://e-words.jp/w/%E3%82%AF%E3%82%A8%E3%83%AA.html)」→「[https:](https://e-words.jp/w/HTTPS.html)//exmaple[.jp](https://e-words.jp/w/JP%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3.html)/」）よう変更されている。


