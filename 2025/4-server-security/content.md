## サーバーセキュリティ範囲

サーバーセキュリティ、プロキシサーバーセキュリティ、WEBサーバー、DNSサーバー、DHCPサーバーなどの仕組み

## サーバー要塞化

様々な脅威への対策を行うことを要塞化という。

1. セキュリティ対策を行った最新バージョンの維持
2. デフォルト状態からの変更
3. 適切なアクセス権の設定
4. ログの設定

デフォルト設定は、広く知られた状態なので危険。

最新のパッチが公開されても以下のような手順で適用する

- OSベンダがセキュリティパッチを公開した場合、リリースノートを確認する
- パッチ担当者は、検証LANのPCに適用し、PC動作に問題ないことを確認する
- パッチに不具合の情報が公開されてないことを確認の上で、セキュリティパッチを配信サーバーに置く
- PCは適用すべきパッチがあるかを常時確認するように設定されてる→定期的な確認を行う

#### EPP・EDRの導入

エンドポイント＝ネットワークの終端のセキュリティ強化をすることが注目されている。


## プロキシサーバー/IAP

プロキシサーバーとはクライアント端末がインターネット上のWEBサーバーにアクセスする際に、当該端末の代わりに代理で応答するサーバーのこと。

通常はDMZに配置される。

アクセスしたWEBページをキャッシュする機能をもつため、ネットワーク負荷低減の役割を持つ、セキュリティ向上のため設置される。

1. 端末の隠蔽
   端末とインターネット上のWEBサーバーが通信している場合でも、プロキシサーバーが両社の間で直接のやり取りをしているため、社内LAN内の端末を隠蔽することが出来る。これにより、クライアント端末自体の安全性を向上することができる。
2. クライアントからのアクセス集中制御
   ファイアウォールで、プロキシサーバー以外の端末のインターネット接続を遮断することで、外部との通信をすべてプロキシサーバー経由に集約できる。→アクセスログのチェックが一元化、URLフィルタリングやアンチウィルスの機能を持たせることで、セキュリティ向上が期待できる
3. 標的型攻撃の出口対策
   標的型攻撃では標的となった端末がマルウェアに感染すると、当該端末がC&Cサーバーに対してコネクトバック通信を試みる。この時に、ファイアウォールで直接の接続を禁止していると、C&Cサーバーとの通信をトリガーとする被害を抑えることが出来る
4. 認証機能
   Internetと接続時に認証機能がついていれば、接続できる端末に制限をかけることが出来る。プロキシを経由するタイプのマルウェアを抑制する効果も期待できる。
5. IAP
   クライアントとアプリケーション間の通信を仲介するプロキシ、ユーザー認証し、ユーザーに許可されているアプリケーションだけを利用させるソリューションをIAPと呼ぶ。防御対象のアプリケーションはオンプレ、クラウド両方。オンプレでもクラウドでもコネクタというサーバーを設置し、IAPはコネクタと通信を行い、コネクタがアプリケーションと通信する。

## WEBサーバーのセキュリティ

WEBサーバーからWEBサーバーに送るデータをリクエスト、サーバーからブラウザに送られるデータはレスポンス。

#### GETメソッド

GetメソッドはブラウザからWEBサーバーにリクエストを送信するときに使われるメソッド。

セキュリティ面では不都合な点あり。フォームより入力したデータは、URL後半のクエリとして返されることになる。ログにも残るし、リファラでリンク先にも送信される→漏洩の可能性がある。

#### POSTメソッド

入力情報をサーバーに送信する際にリクエストボディを使って送信するため、少しは安全性が改善することが出来る。

#### Cookieを利用したセッション管理

HTTP通信は、ステートレスな通信＝リクエストとレスポンスのやり取りで完結する通信。

WEBの通販サイトなどのような一連の画面遷移が必要な場合、セッション管理が必要となる。

セッション管理の代表例がCookieを用いる方法。

Cookieとはサーバとクライアントでやり取りされるテキストデータ。

WEBサーバーからのHTTPレスポンスに①"Set-Cookie"でCookieを使用することを宣言、②セッションIDを記述、しておくと、ブラウザはCookieの値を保持して、アクセスごとのCookieのセッションIDを付けてサーバーに送付するようになる。→これにより連続性のある処理が出来るようになる。

Cookieには属性を指定することが出来る。推奨される設定は以下の通り

1. domain
   domain=itec.co.jpのように指定→指定したドメインとサブドメインのみにcookieを送信するようになる
2. expires
   有効期限。日時で指定。ほかにMax-Ageで指定が可能
3. secure
   設定すると、http通信で保護されているときしかcookieを送信しなくなる
4. HttpOnly
   設定すると、cookieへのアクセスがhttpからのみになる。→javascript等のスクリプトからアクセスできなくなる。このためXSS脆弱性があってもcookieから読み取られなくなる。

#### 脅威
##### セッションハイジャック
HTTPセッション管理ではCookieを用いる手法が一般的となっている。
そのほかの方法には以下のようなものもある。
- クエリストリングにセッションIDを含める方法
- hiddenフィールドにセッションIDを含める方法
上記のセッションIDが処理の連続性を保つ情報となる→盗聴or推測されるとなりすましされる。
__対応法__
- cookieの取り扱いを安全にする
- 推測しづらいセッションIDにする
- 必要最低限のdomainと有効期限を設定する。httponlyもできる限り設定

##### セッションフィクセーション
攻撃手順は以下の通り
1. 攻撃者が、正規のWEBサイトよりセッションIDを取得する
2. 別の利用者に対して、セッションIDを送り込み、正規のWEBサイトにログインする
3. ログイン状態になったら、攻撃者が利用者になりすます
※上記攻撃は、ブラウザにcookieモンスターバグという脆弱性がある場合や、HTTPヘッダインジェクションの脆弱性がある場合、攻撃者の用意したcookieを受け入れてしまい攻撃が成功する

__対応法__
認証が終わった後、WEBサイトが新規のセッションIDを発行する。

##### HTTPヘッダインジェクション
HTTPリクエストのクエリストリングに、不正コードを挿入して、悪意あるスクリプトを埋め込んだHTTPレスポンスを作成して、ブラウザに攻撃者の悪意を持つフォームを表示させるなどのHTTPヘッダに悪意あるコードを混入させる攻撃を、HTTPヘッダインジェクションと呼ぶ。
HTTPヘッダインジェクションは、ユーザーが入力したデータを適切に検証せずにHTTPレスポンスヘッダに反映させることで発生する脆弱性。
例. 以下サイトにアクセスする
```http
http://example.com/redirect.php?to=home
```
このサイトに対して、以下のようなクエリストリングを追加する
```http
http://example.com/redirect.php?to=home%0d%0aSet-Cookie:%20sessionId=abcd1234
```
このクエリストリングの%0d%0aは、CRLF（キャリッジリターンとラインフィード）を表し、HTTPヘッダの改行を意味します。このように改行を挿入することで、新しいHTTPヘッダを追加することができます。この例では、Set-Cookie: sessionId=abcd1234という新しいヘッダが追加され、セッションIDが固定されてしまいます。

このような攻撃を防ぐためには、ユーザー入力を適切にサニタイズし、改行コードを含む不正なデータを除去することが重要です。

%0d%0aが2回続くと、空白行が２個あることになる→ヘッダとボディを分けることになる

###### 重要ファイルを公開ディレクトリにおかない
検索エンジンにひっかかったり、ディレクトリトラバーサル攻撃により重要ファイルが流出する可能性がある

###### HTTP認証
HTTPプロトコルに標準で用意されている認証方式＝HTTP認証をもちいることがある
- Basic認証
  入力したIDとPWを平文で送出することになるため危険
- Digest認証
　Basic認証の弱点を改善した手法で、IDとPWをハッシュ化して送出する
　1. サーバーでランダムな文字列(nonce)を生成し、クライアントに送信
　2. ユーザがログインIDとPWを入力
　3. PWにnonceを付与し、ハッシュ化したデータをサーバーに送信
　4. サーバー側で受信データを確認する
　※nonce：暗号や認証プロトコルで仕様される使い捨てのランダムな文字列のこと

##### オープンリダイレクト対策
次のようなURLを実行し、システムにアクセスした際に別のサイトに異動させる機能。
Webアプリケーションのリダイレクト機能を悪用して、ユーザーを攻撃者が用意したページに誘導する脆弱性。
```
https://example.com/redirect?url=https://malicious-site.com
```
この場合、この場合、https://example.comのサブドメインに見せかけたhttps://example.com.evil.comにリダイレクト
```
https://example.com/redirect?url=https://example.com.evil.com
```
##### CORS
CORS（Cross-Origin Resource Sharing）は、異なるオリジン間でリソースを共有するための仕組みです。通常、ウェブブラウザはセキュリティ上の理由から、同一オリジンポリシー（Same-Origin Policy）を適用し、異なるオリジンからのリクエストを制限します。しかし、CORSを使用することで、特定の条件下で異なるオリジンからのリクエストを許可することができる。

__CORSの仕組み__
リクエスト送信: クライアント（ブラウザ）がサーバにリクエストを送信します。
サーバの応答: サーバは特定のHTTPヘッダー（例: Access-Control-Allow-Origin）を使用して、どのオリジンからのリクエストを許可するかを指定します。
ブラウザの確認: ブラウザはサーバの応答を確認し、許可されたオリジンからのリクエストであればリソースにアクセスします。
※サーバーがアクセスして良いオリジンを指定する仕組み→ブラウザが変はサイトからのレスポンスを受けることがなくなる仕組み

##### WAF
Webaアプリケーションへの攻撃を防ぐために、サーバー側に導入されるものがWAF。
問題ある通信パターンを遮断や無害化。
正常な通信のみを通過させる。
PCI DSSでは、一般公開されているWebアプリケーションは、定期的な脆弱性への対応か、WAFの導入をしなければならないと定めている。

例:aws waf設定例
```
{
  "Name": "BlockSpecificIP",
  "Priority": 1,
  "Action": {
    "Block": {}
  },
  "Statement": {
    "IPSetReferenceStatement": {
      "ARN": "arn:aws:wafv2:region:account-id:ipset/BlockIPSet"
    }
  },
  "VisibilityConfig": {
    "SampledRequestsEnabled": true,
    "CloudWatchMetricsEnabled": true,
    "MetricName": "BlockSpecificIP"
  }
}
```

## DNSサーバーのセキュリティ
ドメイン名からIPアドレスの対応関係を管理するためのサーバー。
２種類存在する。
1. ドメイン名とIPアドレスの対応関係を管理する権威DNSサーバー
2. 端末からの問い合わせに解答するキャッシュDNSサーバー
#### 名前解決手順
1. クライアントPCのリゾルバがFQDNをキャッシュサーバーに対して名前解決の問い合わせを行う
2. キャッシュサーバーはルートDNSサーバーから順番にFQDNの構成名について問い合わせを行う
3. 最終的にFQDNの権威DNSサーバーが対応するIPアドレスを返す
#### 脅威
CDNサーバー：オリジナルサーバーの代わりにアクセスを受け付けてクレスキャッシュサーバー配置させたネットワーク。負荷分散やレイテンシの平準化のために利用する。

| 攻撃名 | 攻撃内容 |
| ------- | ---------------------------------------------------------------------- |
| DNSキャッシュポイズニング | キャッシュDNSサーバに不正な情報を送信して、本来とは異なるwebサーバーに誘導させる攻撃 |
| DNSリフレクション | DNSサーバーの再帰的な問い合わせを悪用したサービス不要攻撃。インターネットからアクセスできるキャッシュサーバーに送信元IPアドレスを攻撃対象のOP青dレスに偽装したDNS問い合わせを行う。するとDNS応答は攻撃対象のサーバーに送信され、攻撃対象サーバーのリソースを消費することになる |
| サブドメインステークオーバー | CDNサービスやクラウドサービスを利用する際に、CNAMEレコードを使って、サブドメインを使って、攻撃者が用意した罠サイトに誘導する攻撃 |

#### セキュリティ対策
1. 不要なレコードを残さない
   CDNやクラウドサービスを停止した場合、CNAMEやAレコードは削除する
2. オープンリゾルバの禁止
   オープンリゾルバを禁止する。
   具体的には権威DNSサーバーと、キャッシュDNSサーバーを分類して、キャッシュサーバーにインターネットから問い合わせできないようにして、悪用されないようにする。
   ※キャッシュサーバーにはコンテンツ機能を持たせない。
   ※キャッシュサーバーに適切なアクセスコントロールを施して、インターネットからのアクセスを禁止する
3. ソースポート乱打米ゼーション
   キャッシュDNSサーバーでは、権威DNSサーバーに遠い合わせる場合、IDやポート番号を保持して起き、正しい応答かどうかを判断するようにする。この時にポート番号をランダム化して、攻撃者が推測・悪用できないようにする
4. DNSSEC
   DNSのセキュリティを強化するための拡張しよう。DNSレコードにデジタル署名を施すことで、正当性を証明する。
   正当性のチェックや改ざんの有無を検出することが可能となるが、仕組みが大がかりになるのが難点


##### CNAMEレコード
CNAMEレコード（Canonical Nameレコード）は、DNS（Domain Name System）で使用されるレコードの一種で、あるドメイン名を別のドメイン名に関連付けるために使用されます。これにより、ドメイン名のエイリアス（別名）を作成することができます。

例. www.example.comにアクセスすると、実際にはexample.comにアクセスすることになります
```
www.example.com. IN CNAME example.com.
```
※CNAMEレコードは他のDNSレコード（例えば、MXレコード）と同じドメイン名に対して同時に使用することはできません。


## DHCPサーバー
端末に固定のIPアドレスを設定するのではなく、端末が起動の度にIPアドレスを自動的に割り当てるというプロトコルがDHCP。
割り当てるサーバーをDHCPサーバー。割り当てられるクライアントをDHCPクライアントと呼ぶ。
通信はUDPより行われる。
主要なOSやルータにはDHCPサーバーの機能が搭載されている→ルータ以上のデバイスを設定すれば、基本配下のネットワークの端末は勝手にIPアドレス降られるような設定ができる。

#### ユニキャストアドレス
ユニキャストアドレスとは、ネットワーク通信において、特定の1つの受信者にデータを送信するためのアドレスです。具体的には、IPアドレスやMACアドレスがこれに該当します。

__ユニキャストアドレスの特徴__
一対一の通信: ユニキャストアドレスは、送信者が特定の1つの受信者に対してデータを送信するために使用されます。
例: 通常のウェブブラウジングやメールの送受信など、特定の相手にデータを送る際に使用されます。

#### リレーエージェント
同一サブネット内にDHCPサーバーが存在しない場合、ルータにリレーエージェント機能があれば、別のサブネットのDHCPサーバーとやり取りすることができる
ルータはブロードキャストアドレスをユニキャストアドレスに変換ｓいて、別サブネットのDHCPサーバーにDHCPディスカバーメッセージを送信する。

#### IPアドレス発行まで
1. クライアント端末がDHCP Discoverをブロードキャストアドレスで送信
2. DHCPサーバーがDHCP OFFERを送信。プールからIPアドレスを提案する。
3. クライアントが早い者勝ちで提案された内容に対して、DHCP REQUESTを返す
4. DHCPサーバーがDHCP Packを送信すればIPアドレスの設定が完了


## LDAPサーバー

LDAP（ディレクトリサービスとやり取りするときに使うお約束事）を使ってやりとりできる、ディレクトリサービス

（ネットワークの世界における「俺がいろんな情報をまとめて管理しているから、なにか困ったことがあったら俺に聞いてこい」型サービス）を提供するコンピュータのこと

#### ディレクトリサービス

ネットワーク上でさまざまな情報を一元管理し、必要な情報を提供するサービス

例えば、プリンタの場所やユーザーの認証情報などを管理します。ディレクトリサービスを提供するコンピュータは「サーバ」と呼ばれ、他のコンピュータが必要な情報を問い合わせると、その情報を提供します

ディレクトリサービスの例としては、WindowsのActive Directoryが有名です。ディレクトリサービスを利用する際には、通信プロトコルとしてLDAP（Lightweight Directory Access Protocol）がよく使われます



#### リファラ

[Webブラウザ](https://e-words.jp/w/Web%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6.html)が[Webサーバ](https://e-words.jp/w/Web%E3%82%B5%E3%83%BC%E3%83%90.html)への[HTTPリクエスト](https://e-words.jp/w/HTTP%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88.html)送信時に「Referer:」[ヘッダ](https://e-words.jp/w/%E3%83%98%E3%83%83%E3%83%80.html)で申告する[情報](https://e-words.jp/w/%E6%83%85%E5%A0%B1.html)で、これをたどっていくと閲覧者がどこの[サイト](https://e-words.jp/w/%E3%82%B5%E3%82%A4%E3%83%88.html)から[訪問](https://e-words.jp/w/%E3%83%93%E3%82%B8%E3%83%83%E3%83%88.html)したのか、また、[サイト](https://e-words.jp/w/%E3%82%B5%E3%82%A4%E3%83%88.html)内でどのような軌跡をたどったのかなどを調べることができる。


##### Refererヘッダ

[Webブラウザ](https://e-words.jp/w/Web%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6.html)はページの[リンク](https://e-words.jp/w/%E3%83%AA%E3%83%B3%E3%82%AF.html)を[クリック](https://e-words.jp/w/%E3%82%AF%E3%83%AA%E3%83%83%E3%82%AF.html)あるいは[タップ](https://e-words.jp/w/%E3%82%BF%E3%83%83%E3%83%97.html)して次のページに移る際に、遷移元のページの[URL](https://e-words.jp/w/URL.html)をReferer[ヘッダ](https://e-words.jp/w/%E3%83%98%E3%83%83%E3%83%80.html)として[HTTPリクエストヘッダ](https://e-words.jp/w/HTTP%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%98%E3%83%83%E3%83%80.html)中に記載することになっている。記載の可否や内容はReferer-Policy[ヘッダ](https://e-words.jp/w/%E3%83%98%E3%83%83%E3%83%80.html)や[HTMLファイル](https://e-words.jp/w/HTML%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB.html)中の[metaタグ](https://e-words.jp/w/meta%E8%A6%81%E7%B4%A0.html)である程度指定できる。

以前は[パス](https://e-words.jp/w/%E3%83%91%E3%82%B9.html)や[クエリ](https://e-words.jp/w/%E3%82%AF%E3%82%A8%E3%83%AA.html)など完全な[URL](https://e-words.jp/w/URL.html)を記録するのが原則だったが、[利用者](https://e-words.jp/w/%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC.html)の[ネット](https://e-words.jp/w/%E3%83%8D%E3%83%83%E3%83%88.html)上での活動履歴を[サイト](https://e-words.jp/w/%E3%82%B5%E3%82%A4%E3%83%88.html)運営者に知らせることになるため、近年では異なる[ドメイン](https://e-words.jp/w/%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3.html)間の遷移では[ドメイン](https://e-words.jp/w/%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3.html)名部分しか送らない（「[https:](https://e-words.jp/w/HTTPS.html)//[example.jp](https://e-words.jp/w/example.com.html)/[dir](https://e-words.jp/w/dir%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89.html)/page.[html](https://e-words.jp/w/HTML.html)?q=[query](https://e-words.jp/w/%E3%82%AF%E3%82%A8%E3%83%AA.html)」→「[https:](https://e-words.jp/w/HTTPS.html)//exmaple[.jp](https://e-words.jp/w/JP%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3.html)/」）よう変更されている。


#### JSONP（JSON with Padding）
異なるドメイン間でデータを取得するための技術です。
通常、ウェブブラウザはセキュリティ上の理由から、同一生成元ポリシーにより、異なるドメインからのデータ取得を制限しています。
しかし、JSONPを使用すると、この制約を回避できます。
JSONPはHTMLの<script>タグを利用してデータを取得します。<script>タグは異なるドメインからJavaScriptファイルを読み込むことができるため、この特性を利用してデータを取得します。サーバー側では、クライアントからのリクエストに対して、JavaScript関数を呼び出す形式でデータを返します。
```
<script src="https://example.com/data?callback=parseResponse"></script>
```

```JSON
parseResponse({"name": "John", "age": 30});
```
JSONPは便利な技術ですが、セキュリティ上のリスクも伴います。例えば、クロスサイトリクエストフォージェリ（CSRF）攻撃のリスクがあるため、機密情報の取り扱いには注意が必要です。


# 2nd
## クロスドメイン

複数のドメインからデータを持ってくる
ホームページの話
Ajaxの話題で出てくる
ホームページを表示した時に、複数のドメインからデータをもってくるようになっている状態。

## Same-Origin
同一生成元ポリシーなる仕組みを実装している。
異なるオリジンのリソースへのアクセスに制約をかける。
JSONPやCORSを活用することで一部解除出来る。

### オリジン
オリジンは
スキーム、ホスト、ポート番号の組合せ

http://site-a.example.com:80/

### JSONP
JSONP (JSON with Padding) は、クロスサイト環境で他のオリジンから JSON データを取得するために考案された仕組みです。
JSONPを用いることでクロスオリジンであってもデータのやり取りが出来るようになる。


## XMLHttpRequest
MLHttpRequest という名前ではあるものの、 XML だけでなく、あらゆる種類のデータを受け取るために使用することができます。

通信においてサーバーからのイベントデータやメッセージデータの受信を含む必要があるのであれば、サーバー送信イベントの EventSource インターフェイスを使用することも検討してください。全二重の通信では、 WebSocket の方が良いかもしれません。

## リゾルバ
DNSの仕組みにおけるクライアント側のプログラム

## DNS関係の攻撃
### DNSキャッシュポイズニング
DNSサーバのキャッシュに偽の情報を注入する攻撃手法。
この攻撃が成功すると、利用者は本来アクセスしたい正規のサーバーではなく攻撃者が用意した偽のサーバーに誘導される。

#### 仕組み
1. 攻撃者はターゲットのDNSサーバに対して、存在しないドメインの問合せを発生させる
2. 直後、偽のDNS応答を大量に送り付ける
3. タイミング良く偽応答が受け付けられるとDNSサーバのキャッシュが汚染される
4. この直後、DNSサーバを利用するユーザーは偽のIPアドレスへ誘導される

### DNSリフレクション
DNSサーバを悪用したDDoS攻撃の一種。
攻撃者がDNSサーバを利用して、標的に大量のトラフィックを送り付ける仕組み。

#### 特徴
1. アンプ（増幅）効果
小さなDNSリクエストに対し、大きなDNS応答（例：ANYクエリなど）を返すため、攻撃トラフィックが増幅されます。
2. 送信元偽装
攻撃者の正体が分かりにくい。
3. オープンリゾルバの悪用
インターネット上に公開されているDNSサーバ（オープンリゾルバ）が悪用されやすい。

### 対策
__DNSSEC__

DNSの応答が改ざんされてないことを保証するための拡張規格。
DNSの根本的な弱点である応答なりすましやキャッシュポイズニングを防ぐために設計されている。

## 問題の構成
クラウドかオンプレか。
サーバーにはどんな機能を持つか、未使用の機能は要注意。

## サーバーセキュリティ
### サーバーの要塞化

サーバを要塞のようにして、脅威への耐性をたかめることを要塞化と呼ぶ。
対策は以下のようなもの。
1. セキュリティ対策を施した最新バージョンの維持
2. デフォルト状態からの変更(不要なサービスの停止、不要なアカウントの削除)
3. 適切なアクセス権の設定
4. ログの設定

OSやMWには最新のバッチ(更新プログラムや脆弱性修正プログラム)を適用する。
OSの不要なサービスは停止して、不要なアカウントを削除する。
デフォルト状態は危険。

### エンドポイントのセキュリティの導入
EPP、EDRのセキュリティを強化。
エンドポイントとはネットワークの終端のこと。
クライアント端末と業務サーバやファイルサーバが該当する。

__EPP__

エンドポイントを守るための対策。
マルウェア対策が基本となるため、各種アンチウィルスソフトがメインとなる。

__EDR__

エンドポイントの操作や動作監視を行い、サイバー攻撃をうけたことを発見ん次第対処するソリューション。
EPPは予防対策で、EDRは事後対策。
プロセスの起動、終了、ネットワーク通信、ファイル操作、実行ファイルのパスを記録して検索出来る機能を持っている。

## プロキスサーバ / IAP
プロキシサーバとは、クライアント端末がインターネット上のサーバーにアクセスする際に代理で応答してくれるサーバーのこと。
基本はDMZに配置される。
アクセスしたwebページをキャッシュする機能をもっているので、ネットワーク負荷の軽減やレスポンスの向上を見込むことが出来る。

### プロキシサーバの役割と動作
__1. 端末隠ぺい__

端末とインターネット上のwebサーバーが通信をしている場合でも、実際には端末とプロキシサーバ間、プロキシサーバとインターネット上のwebサーバーの間で通信しているため、社内LANの端末を隠蔽することが出来る。
→クライアント端末自体の案税制を向上することが出来る。

__2. クライアントからのアクセス集中制御__

FWでプロキシサーバ経由のインターネット接続を遮断することで、外部との通信をプロキシサーバー経由に集中できる。
アクセスログのチェックも一元管理できるし、ＵＲＬフィルタリングやアンチウィルスの機能を持たせると、集中的に管理することが出来る。

__3. 標的型攻撃の出口対策__

標的型攻撃では、標的となった端末がマルウェアに感染すると、端末からC&Cサーバーに向けてコネクトバック通信を試みます。
直接C&Cサーバに接続を試みるマルウェアもあるので、プロキシサーバを導入してFWで直接の通信を禁止していると、MWを遮断が可能。

__4. 認証機能__

認証機能付きのプロキシサーバの場合、インターネット接続できる端末に制限をかけることも可能となる。
通常ディレクトリサーバーと連携することも可能。
出口対策においてもプロキシを経由するタイプのマルウェアでも遮断することが期待できる。

__5. IAP__

クライアントとアプリけ0ションの通信を仲介するプロキシで、ユーザー認証しユーザに許可されているアプリケーションのみを利用させるソリューションをIAPと呼ぶ。
守るべき対象となるアプリケーションはオンプレでもクラウドでもOK。
IAPはコネクタと通信を行い、コネクタがアプリケーションと通信する。

リバースプロキシ

インターネットからのアクセスをwebサーバーの代理として受信するプロキシサーバをリバースプロキシと呼ぶ。

## Webサーバーのセキュリティ

ブラウザからwebサーバに送られるデータはリクエスト、webサーバーからブラウザに送付されるデータをレスポンスと呼ぶ。
リクエストの代表的な方式にGETとPOSTがある。

セキュリティ上はGETメソッドを使わずにPOSTを使うように推奨されてる。
理由はクエリストリングにパラメータが出てしまうこと。
すると、URLはアドレスバーに表示、ログに残る、Refererでリンク先にも送信される→漏洩のリスクがあるため、GETは極力使わない方が良いとされる。

## POSTメソッド
入力情報をサーバに送るときに、リクエストボディを使って送信されるので、セキュリティが若干向上する。
ただし、通信をキャプチャされると漏洩してしまう。

## Cookieを利用したセッション管理
HTTP通信は、ステートレスな通信になる。
webの通販サイトのように一連の画面遷移が必要な場合はセッション管理が必要となる。
この時につかわれるのはCookie。

Cookieの値を保存し、次にアクセスするときにCookieのセッションIDをつけてサーバーにリクエストを送付する。

### Cookieの属性

1. domain: 指定したドメインとサブドメインに対してCookieを送信
2. Expires: 有効期限。日時で指定する。必要最小限の期間を設定。
3. Secure: https通信で保護されている時しかCookieを送信しない
4. HttpOnly: 設定すると、CookieへのアクセスがHTTPヘッダからだけとなり、JS等のクライアントのスクリプトからはアクセスできなくなる。これによりXSS脆弱性があってもCookieが読み取られなくなる。

### セッションハイジャック
HTTPのセッション管理にはCookieを使う方法が最も安全。
Cookieがセッション管理の主流となっている。

__クエリストリング__

URLパラメータにセッションIDを含まる方法

__hiddenフィールド__

hiddenフィールドにセッションIDを含める方法

セッションIDが盗聴されたり、推測されるとなりすましされてしまう。
→この状況はユーザーIDとパスワードが盗まれた状況と同じ。

セッションIDを盗まれないようにするためにはCookieを極力安全に使う必要がある。
推測困難、必要最小限のdomain、有効期限を設定、secure属性を設定、可能ならばHttpOnlyとする。

__セッションフィクセーション__

セッションを使ってなりすます攻撃には、他人のセッションを盗むセッションハイジャック以外に悪意ある攻撃者が取得したセッションIDを利用者のWebブラウザに送りこみ、利用者がセッションIDでログインして、セッションがログイン状態に変わった後に、利用者になりすますという攻撃手法がある。

サーバー側の対策としては、Cookieは認証前のもので、認証が終わった後に新たなセッションIDを発行するようにする。

__HTTPヘッダインジェクション__

HTTPリクエストのクエリストリングに次のような不正なコードを挿入し、それにより悪意あるscriptを埋め込んだHTTPレスポンスを作成し、ブラウザ側に表示するなど、HTTPヘッダに悪意あるコードを混入させる攻撃をHTTPヘッダインジェクション攻撃と呼ぶ。

scriptをインベドするのがHTTPヘッダインジェクションと言いますね。
埋め込むのは%0d%0aを埋め込む＝CRLFと同じ。2回繰り返されるとヘッダとボディと分割されることになる。

### 重要なファイルを公開ディレクトリに置かない
外部公開するHPを配備する公開用ディレクトリ配下に、重要なファイルを保存したり、置き忘れないこと。
仮にひっそりと隠しているつもりでいても、検索エンジンに引っかかったり、ディレクトリトラバーサル攻撃によって、重要ファイルが流出する可能性がある。

### HTTP認証
認証が必要なサイトの場合、HTTPプロトコルに標準で用意されている認証方式を使うことがある。
この認証方式にBasic認証とDigest認証が用意されている。

### オープンリダイレクト対策
オープンリダイレクトとはURLを実行し、とあるサイトにアクセスした後に、別サイトに移動させる機能。
この機能を悪用されると、悪意あるサイトに誘導される。

リダイレクト先を事前にと登録したホワイトリストを作成し、リダイレクトでは記載された先にしかいかにようにするなどの対策が求められる。

### Same-OriginポリシとCORS
Same-Originポリシにより制限されるクロスドメインに対して、セキュリティを考慮したCORSの実装が求められる。

### WAF
ネットワーク上に配備するＦＷでは防御しきれないWebアプリけ0ションへの攻撃を防ぐためにサーバー側に導入されるのがWAF。
WAFは問題ある通信パターンを遮断したり、無害化したり、正常な通信を定義しておき、正常な通信のみを通過させることが出来る。

## DNSサーバーセキュリティ
DNSサーバーはドメイン名とIPアドレスの対応関係を管理し、ドメイン名からIPアドレスを参照する用途で使用されるサーバー。
- 権威DNSサーバー：ドメイン名とIPアドレスの対応付け
- キャッシュDNSサーバー：端末からの問合せに回答する

### DNSサーバの名前解決手順
ドメイン名とIPアドレスを得るプロセスを名前解決と呼んでる。
世界中に分散配置しているDNSサーバーが可能としている。

- リゾルバ：DNSサーバに名前解決を依頼するプログラムの名称。
- 再帰問合せ：最終的な回答を期待する問合せでクライアントのリゾルバがキャッシュDNSサーバに対して行う。

### DNSサーバに対する脅威
DNSサーバに対する脅威として、次の攻撃がある。

__DNSリフレクション__

__DNSamp__

DNSサーバの再帰的な問合せを悪用したサービス不能攻撃の一種。
インターネット上からアクセスできる適当なキャッシュDNSサーバに対して、送信元IPアドレスを攻撃対象のIPアドレスに偽造したDNS問合せを行う。
この時にサイズを大きく増幅する攻撃はampと呼ばれる。

__サブドメインステークオーバー__

CDNサービスやクラウドサービスを利用する場合に、DNSサーバのCNAMEレコードを使って転送させることがある。
が、サービス利用を中止したにもかかわらずDNSサーバCNAMEレコードを残したままにしておくと、サブドメインを使って攻撃者が不正サイトを立ち上げて誘導される。

## DHCPサーバのセキュリティ
端末に固定のIPアドレスを設定するのではなく、起動の都度IPアドレスを設定するという運用時に、各端末にIP自動的に割り当てを行う。
- DHCPサーバー：割り当てを行うサーバー
- DHCPクライアント：割り当てられるクライアント

通信はUDPを用いる。
主要なサーバOSやルータには、ほぼDHCPサーバ機能が搭載されている。

ルータにDHCPリレーエージェント機能があれば、別のサブネットのDHCPサーバとやり取りすることが出来る。
この場合、ルータはブロードキャストアドレスをユニキャストアドレスに変換して別サブネットのDHCPサーバにDHCPDISCOVERメッセージを送付する。

### DHCPスプーフィング
同一サブネット上にDHCPサーバが複数台ある場合、より近くにあるサーバがより早く応答するという性質を持つ。
DHCPサーバやデフォルトゲートウェイのIPアドレスだけでなく、DNSサーバやデフォルトゲートウェイのIPアドレスもリリースされるので、フィッシングサイトに誘導されたり、中間者攻撃を受けて盗聴されて改ざんされる可能性がある。

## データベースサーバーのセキュリティ
データベースサーバには企業内の重要情報がある。
サーバーの要塞化を実施するとともに配置する場所にも注意が必要。

HDDやバックアップデータの物理的盗難リスクに対して、ガードされている区間に配置しないといけない。

### 表領域暗号化機能
表領域暗号化機能はデータベースの表領域全体を暗号化する機能。

データベースに書込みを行うとともに、DBMSで自動的に暗号化や復号してくれるので、利用者は意識する必要がない

### バックアップデータの暗号化
データベースのバックアップを外部メディアにとって保管する場合にも暗号化を検討しなくてはいけない。
バックアップ媒体が盗難されても、バックアップデータを解析できないようにしておけば情報漏洩は防ぐことが出来る。

### 通信経路の暗号化
DB側で透過的に暗号化するようにしても、アプリケーションとDBの通信を盗聴されると情報が漏洩する。
そこで、DBとアプリケーションの間の通信経路の暗号化も検討すべき。

### フルサービスリゾルバー（キャッシュDNSサーバー）
スタブリゾルバー（DNSクライアント）から送られる「名前解決要求」を受けて、他の権威サーバー（権威DNSサーバー）に対して「非再帰検索（反復検索）」という形で問い合わせを行い、その結果をスタブリゾルバーに応答として返すリゾルバーです。

