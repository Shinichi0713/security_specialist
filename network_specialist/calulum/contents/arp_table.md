
組織内のネットワーク内でデータを送受信する際にはIPパケットと呼ばれるデータの塊にする必要があります。
このデータの塊を相手に送信する際にルーティングテーブルとARPテーブルが必要となります。

組織な中のネットワークでデータを届ける仕組みについて説明していきます。

## 概要
ルーティングテーブルとARPテーブルは、どちらもルーターやPCがパケットを転送するために参照する「地図」のようなものですが、 **「どの階層（レイヤー）の住所を解決するか」** という役割が明確に異なります。

一言でいうと、 **ルーティングテーブルで「次に行くべき中継地点（IP）」を決め、ARPテーブルで「その中継地点の物理的な顔（MACアドレス）」を特定する** という、連係プレーの関係にあります。


### 1. ルーティングテーブル（L3：ネットワーク層の地図）

ルーティングテーブルは、ルーターやPCの中に存在する　**「ネットワークの案内図」**　です。

* **役割:** 宛先のIPアドレスを見て、パケットを　**「どのインターフェース（出口）」**　から、　**「どの次ホップ（隣のルーター）」**　へ送ればいいかを出力します。
* **判断基準:** 宛先IPアドレスとサブネットマスクを照合します。
* **主な項目:**
* **宛先ネットワーク:** 行き先のネットワーク住所。
* **ゲートウェイ（次ホップ）:** 次にパケットを渡すべき相手のIP。
* **インターフェース:** パケットを送り出す物理ポート（LAN1など）。



### 2. ARPテーブル（L2：データリンク層の対応表）

ARPテーブルは、同じネットワーク内にいる機器の　**「IPアドレスと物理的な身分証（MACアドレス）の紐付けリスト」**　です。

* **役割:** ルーティングテーブルで決まった「次ホップのIPアドレス」を、ケーブル上を流れる信号として届けるために必要な　**「MACアドレス」**　に変換します。
* **判断基準:** IPアドレスをキーにして検索します。
* **主な項目:**
* **IPアドレス:** 通信相手の論理住所。
* **MACアドレス:** そのIPを持つ機器の固有番号。



### 3. 両者の連係プレー（具体例）

あなたがPC（192.168.1.10）から、インターネット上のWebサーバーにアクセスする場合を考えてみましょう。

1. **ルーティングテーブルを引く**
PCは「宛先は外部ネットワークだ。だから **デフォルトゲートウェイ（ルーター：192.168.1.1）** に送ろう」と判断します。
2. **ARPテーブルを引く**
PCは「ルーター（192.168.1.1）の**MACアドレス**は何かな？」とARPテーブルを見ます。
3. **パケットの送出**
MACアドレスが判明したら、そのアドレスを宛先にした「MACフレーム」を作り、電気信号としてルーターへ飛ばします。


### 4. 関係性の例

この2つの関係を「旅行」に例えると非常に分かりやすくなります。

* **ルーティングテーブル = 「乗り換え案内アプリ」**
「目的地（最終IP）に行くには、まずは〇〇駅（次ホップIP）で乗り換えなさい」と教えてくれます。
* **ARPテーブル = 「駅のホームでの視覚情報」**
「〇〇駅（次ホップIP）に行くための電車は、あそこに停まっている『青い車両（MACアドレス）』だ」と認識して、実際に乗り込む（フレームに詰め込む）作業を助けます。


## なんでMACアドレスが必要となるか？

物を運ぶときにアドレスが必要なことはわかります。
そういう意味ではインターネット中のアドレスを示すIPアドレスが必要なことはわかります。

なぜ近隣を示すMACアドレスが必要となるのでしょうか？

結論から言うと、現在のネットワークの主流である　**イーサネット（有線LAN）やWi-Fi**　という仕組みが、 **「MACアドレスを見てデータを届ける」というルール（L2プロトコル）で物理的に動いているから** です。

なぜIPアドレスだけではダメなのか、その理由は大きく分けて3つあります。


### 1. IPアドレスは「論理的」で、MACアドレスは「物理的」だから

IPアドレスは、人間がネットワークを管理しやすいように後から割り振った「仮の住所」です。一方、MACアドレスはハードウェア（LANカードやWi-Fiチップ）に焼き付けられた「個体識別番号」です。

* **例え:** IPアドレスが「部署名（営業部 1番デスク）」だとしたら、MACアドレスは「その人の氏名（田中太郎）」です。
* **理由:** 席替え（IPの変更）があっても、本人が誰か（MACアドレス）を特定できないと、物理的に荷物を手渡すことができません。

### 2. スイッチ（ハブ）がIPアドレスを理解できないから

私たちがLANケーブルを指している **「スイッチングハブ」** は、第2層（L2）の機器です。

* スイッチの内部には「どのポートにどのMACアドレスの機器がつながっているか」というリスト（MACアドレステーブル）しかありません。
* スイッチはIPパケットの中身（L3ヘッダ）を読み取って判断する機能を持っていないため、MACアドレスという「外装」に宛先が書いていないと、どの穴に電気信号を流せばいいか分からないのです。

### 3. 「同じネットワーク」の定義がL2に基づいているから

データが同じ組織内（同じサブネット内）にある場合、ルーターを通らずに直接通信を行います。

* **直接配送の仕組み:** 送信元は「宛先は自分と同じ町内（L2セグメント）だ」と判断すると、相手の玄関まで直接届けに行こうとします。
* このとき、電気信号を物理的な線に乗せるための最終的な「宛先スタンプ」として、相手のハードウェアを指し示すMACアドレスが必要になります。


## ARPテーブル作成の流れ

ARPテーブルに目的のMACアドレスが載っていない場合、ネットワークは **「ARPリクエスト」** という仕組みを使って、リアルタイムで相手を探し出します。

これは、同じネットワーク内にいる全員に「大声で問いかける」という非常にダイナミックな動きをします。そのステップを詳しく見ていきましょう。


### 1. ARPリクエストの仕組み（4つのステップ）

例えば、PC（A）が同じネットワーク内のPC（B）にパケットを送りたいけれど、BのMACアドレスを知らない場合を想定します。

#### ① ブロードキャストで「大声」を出す

PC（A）は、ネットワーク全体に対して **「ARPリクエスト」** という特別なパケットを送ります。

* **宛先MACアドレス:** `FF:FF:FF:FF:FF:FF`（ブロードキャスト）
* **内容:** 「IPアドレスが `192.168.1.5`（PC B）の人は誰ですか？ あなたのMACアドレスを教えてください！ 私（PC A）のMACアドレスは `AA:AA...` です」

#### ② 全員が受け取って中身を確認

ブロードキャストなので、同じネットワーク（スイッチ）に繋がっている**すべての機器**にこのメッセージが届きます。各機器は一旦このパケットを開封して中身を確認します。

#### ③ 該当者以外は無視

自分とは違うIPアドレス宛のリクエストだと気づいた他のPC（CさんやDさん）は、「自分じゃないな」と判断して、そのパケットを静かに破棄します。

#### ④ 該当者（PC B）だけが返信（ユニキャスト）

自分のIPアドレスだと気づいたPC（B）だけが、 **「ARPリプライ（返答）」** を返します。

* **宛先MACアドレス:** `AA:AA...`（PC Aへの1対1の通信：ユニキャスト）
* **内容:** 「私が `192.168.1.5` です。私のMACアドレスは `BB:BB...` ですよ」


### 2. 学習と記録

PC（A）は返ってきたMACアドレスを受け取ると、以下の処理を行います。

1. **ARPテーブルへの書き込み:** 忘れないように「`192.168.1.5` ＝ `BB:BB...`」とリスト（ARPテーブル）に記録します。
2. **パケットの送信:** ようやく本来送りたかったデータに、宛先MACアドレス `BB:BB...` を書き込んで送信します。


### 3. ARPリクエストの重要なポイント

* **ルーターを越えない:**
ブロードキャストなので、ルーターの先にある別のネットワークには届きません。あくまで「同じLAN内」の相手を探すための手段です。
* **寿命（キャッシュタイム）がある:**
一度覚えたARPテーブルの情報も、数分〜数十分経つと消去されます。これは、機器がネットワークからいなくなったり、別のIPに変わったりした際に対応するためです。
* **ネットワークの静寂性:**
一度ARPリクエストで解決すると、しばらくはテーブルを見るだけで済むため、無駄な「大声（ブロードキャスト）」は発生しなくなります。

## 結論

組織内のネットワークは機器の羅列です。
そのどこに目的の機器かを調べるにはMACアドレスを調べる必要があります。
ものを届けるというのは最終的な宛先だけでは届かないというネットワークな訳でした。


