**VRRP（Virtual Router Redundancy Protocol）** は、ネットワークの「出口」であるデフォルトゲートウェイ（ルーター）を **冗長化（バックアップ）** するためのプロトコルです。

一言でいうと、 **「2台（以上）のルーターを、PC側からは1台の『仮想ルーター』に見せかける技術」** です。


### 1. なぜVRRPが必要なのか？

通常、PCなどの端末には「デフォルトゲートウェイ」として1つのIPアドレスを設定します。

* **問題点:** もしそのルーターが故障すると、PCは外の世界（インターネット等）と一切通信できなくなります。たとえ横に予備のルーターを置いていても、PC側の設定を手動で書き換えない限り、通信は復旧しません。
* **解決策:** VRRPを使えば、メインのルーターが壊れても、**自動的かつ瞬時**に予備のルーターが通信を引き継ぎます。


### 2. VRRPの仕組み

VRRPを組んだ複数のルーターは、物理的なIPアドレスとは別に、共通の **「仮想IPアドレス（VIP）」** と **「仮想MACアドレス」** を持ちます。

1. **マスタールーター (Master):** 通常時に通信を担当する「現役」のルーター。仮想IP宛のパケットを処理します。
2. **バックアップルーター (Backup):** 出番を待っている「控え」のルーター。
3. **VRRPアドバタイズメント:** マスタールーターは、自分が生きていることを証明するために、定期的に（通常1秒おき）バックアップルーターへ通知を送ります。

#### 切り替わりの流れ

1. マスタールーターが故障し、通知が途絶える。
2. バックアップルーターが「マスターがいなくなった！」と判断。
3. バックアップルーターが新たな「マスター」となり、**仮想IPアドレスを引き継ぎます。**
4. PC側は設定を変えることなく、そのまま通信を続けられます。


### 3. メリットと特徴

* **PC側の設定変更が不要:** PCはあくまで「仮想IP」をゲートウェイに指定しているだけなので、裏側でルーターが入れ替わっても気づきません。
* **ベンダーを選ばない:** 標準化されたプロトコル（RFCで規定）なので、異なるメーカーのルーター間でもVRRPを組むことができます（※Cisco独自のHSRPという似た機能もあります）。
* **切り替わりが速い:** 設定によりますが、数秒程度で切り替わるため、ユーザーは通信断にほとんど気づきません。


### 4. 負荷分散への応用（マルチグループVRRP）

単に1台を休ませておくのはもったいないため、複数のVRRPグループを作ることもあります。

* **グループA:** ルーター1がマスター、ルーター2がバックアップ。
* **グループB:** ルーター2がマスター、ルーター1がバックアップ。

このように設定し、PC半分ずつに異なるゲートウェイを指定することで、 **故障に備えつつ、普段は2台のルーターに負荷を分散させる** といった運用も可能です。

## 仮想グループ

VRRPが形成する「仮想グループ」とは、複数の物理的なルーターが協力して、ネットワーク上で **1台の架空のルーター（仮想ルーター）として振る舞うためのまとまり** のことです。

これまでの解説を踏まえて、この仮想グループが具体的にどのような要素で構成され、どのように機能するのかを深掘りします。


### 1. 仮想グループを形作る「3つの共通資産」

同じ仮想グループ（同じVRIDを持つグループ）に属するルーターたちは、以下の情報を共有し、外からはあたかも「1つの出口」に見えるように振る舞います。

* **仮想IPアドレス (VIP):** PC（クライアント）がデフォルトゲートウェイとして設定するアドレスです。
* **仮想MACアドレス:** 先ほどお話しした通り、VRIDから生成される共通のMACアドレスです。
* **VRID (Virtual Router ID):** そのグループを識別するための背番号です。

>__VRID__  
> **「どのルーターたちが同じグループ（仮想ルーター）に属しているか」** を識別するためのID番号のことです。一言でいうと、**「仮想ルーターのグループ番号」**です。
>__VRIDの役割__  
>VRRPでは、2台以上の物理ルーターを組み合わせて1台の仮想ルーターに見せかけますが、ネットワーク内には複数の仮想ルーターが存在する場合があります（部署ごとにゲートウェイを分けている場合など）。
>* **グループの識別:** ルーターAとルーターBが「VRID: 10」という同じ番号を持っていれば、この2台は協力して1つの仮想IPを守ります。
>* **混線の防止:** 別のグループ（VRID: 20）の通信と混ざらないように、VRIDを使って自分たちのグループ宛のメッセージ（アドバタイズメント）を判別します。
>__VRIDとMACアドレスの関係__  
>VRRPにおいて、VRIDは非常に重要な役割をもう一つ持っています。それは、 **「仮想MACアドレス」の生成** です。
>仮想ルーターは独自のMACアドレスを持ちますが、その多くは以下のようなルールで自動生成されます。
> **00-00-5E-00-01-XX** （XXの部分がVRIDになる）
>例えば、 **VRIDが「10」** であれば、仮想MACアドレスの下2桁は16進数の「0A」となり、**00-00-5E-00-01-0A** というアドレスが使われます。
>PC（クライアント）はこの仮想MACアドレス宛にパケットを送るため、VRIDが正しく設定されていないと、通信の宛先が迷子になってしまいます。

### 2. グループ内の「役割分担」

仮想グループの中では、常に「リーダー」と「控え」が明確に決められています。

* **マスタールーター（1台のみ）:**
グループのリーダーです。仮想IP宛に届くパケットを実際に転送し、ARPリクエスト（IPアドレスからMACアドレスを尋ねる通信）に応答します。
* **バックアップルーター（1台以上）:**
リーダーの座を狙う控え選手です。通常時は何もしませんが、マスターからの「生きてるよ通知（アドバタイズメント）」を常に監視しています。

### 3. 仮想グループの「境界線」

仮想グループは、基本的に **同じセグメント（同じVLANやLAN）内** で形成されます。

* もし、社内に「営業部VLAN」と「総務部VLAN」がある場合、それぞれのVLANごとに独立した仮想グループ（例：営業部はVRID 10、総務部はVRID 20）を作成します。
* これにより、各部署のユーザーはそれぞれの「仮想ゲートウェイ」を通じて、ルーターの故障を意識することなく通信ができます。

### 4. なぜ「グループ」と呼ぶのか？

それは、 **「ルーター単位」ではなく「機能単位」でまとまっているから** です。
例えば、1台の物理ルーターが複数のVLANを受け持っている場合、あるVLANでは「マスター（現役）」として働き、別のVLANでは「バックアップ（控え）」として働く、といった複雑な構成も可能です。これを組み合わせることで、前回少し触れた「負荷分散」が実現します。


### まとめ

VRRPの仮想グループとは、 **「共通のID(VRID)とIP、MACアドレスを持ち、一致団結して1台のルーターになりすますチーム」** のようなものです。

このチームワークのおかげで、物理的な機器が入れ替わっても、ネットワークを利用するユーザー側には一切影響が出ない仕組みになっています。



