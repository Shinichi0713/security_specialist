## ディジタル証明書

PKIとはPKを用いてデジタル署名の正当性を証明する基盤(システム)

RA・CA：ある意味公的な証明書の発行を行う機関
秘密鍵：秘密に保管しておく
デジタル署名：契約書に押印
デジタル証明書：デジタル署名の正当性を証明する役割

#### デジタル証明書

デジタル署名の正当性を証明するデジタル証明書
デジタル証明書の中に存在する情報

- 公開鍵
- 有効期限
- 証明書の正当性(認証局のデジタル証明書)
  表記のフォーマット：X.509
  X.509という言葉は一般的にはIETFのPKI(X.509)と証明書失効リストプロファイル（CRL）
  X.509形式は証明書、CRLのフォーマット

#### PKIの運用環境

3つの役割

- CA:デジタル証明書のお墨付きを与える信頼のおける第3者機関
- RA:利用者からデジタル証明書の登録を受け付けて承認や認可を行う機関
- IA:デジタル証明書の正当性をかくにんするAPPが直接やり取りを行う

## PKIの仕組み

#### デジタル証明書が発行されるまでの手順

1. 本人が公開鍵の鍵ペア生成
2. 秘密鍵は保管。公開鍵と登録申請書記載→RAに申請(CSRと呼ぶ)
3. RAはCSRを受け取ると内容を審査する
4. CAがデジタル証明書を発行

#### デジタル証明書の利用例

通信相手の正当性を検証する

1. 送信者は文章のハッシュ値を計算→メッセージダイジェストと呼ばれる
2. メッセージダイジェストを秘密鍵を用いて暗号化→デジタル署名
3. 送信メッセージに、CAより発行されたデジタル証明書を添付
4. 3と文章、デジタル署名を相手に送信する
5. 送信者は4の内容より、デジタル署名を検証し、CAの正当性を確認する
   1. CAの公開鍵を用いてCAのデジタル署名を復号→デジタル証明書のハッシュ値を算出
6. デジタル証明書の中にあるPKを用いて、主体のデジタル署名を元のメッセージダイジェストに戻す
7. 受信者は受信した文章とデジタル署名を用いて、相手の正当性を確認する
8. 復号した送信メッセージダイジェストと、作成した作成メッセージダイジェストを比較する


CSR:デジタル証明書を取得するためのCAに対する申請書

CPS:認証局運用規定のこと。CA側でCPを作成して管理して、公開する。



#### デジタル証明書のチェック方法

取得したデジタル証明書のチェックする内容について説明する。

1. デジタル署名の検証
2. 有効期限の検証
3. 失効情報のチェック
4. ルート認証局、ルート証明書の検証
5. 証明書のレベルチェック
6. アクセス先のチェック


__失効情報のチェック__

有効期限が残っているのに強制的に執行することがある

CRLを確認する方法と、OCSPを確認する方法がある

__ルート認証局、ルート証明書の検証__

ルート認証局が信頼してよいCAかどうかを確認する

※ルート認証局は誰でも立ち上げることが出来るため。自組織で信頼してよいかが判断されたCAかをチェックする必要がある

巷で使われるブラウザにはデフォルトで信頼されたルート認証機関がインストールされていて、ここにない認証局が発行したデジタル証明書であることが確認されると”信頼されていない”

__証明書のレベル__

発行時の確認内容や審査内容の厳格さにより以下の３種類に分けられる

DV: ドメインだけを確認

OV: 企業や組織の実在性を確認

EV: OVよりも厳しく内容を確認

__アクセス先のチェック__

デジタル証明書を検証する場合、アクセス先のサーバがデジタル証明書に記載されたものと同じかをチェックして確認。確認するのは以下の２つ

| デジタル証明書                           | アクセス先 |
| ---------------------------------------- | ---------- |
| subejectAltName(SAN)に記載されているFQDN | FQDN       |
| subjectに記載されているFQDN              | FQDN       |

__SAN__

サーバー証明書のSubjectAltNameフィールド。

SANには、そのサーバー証明書を設定・使用するサーバーを示すドメイン名・IPアドレス・URIなどを記述し、それらの識別子（ID）をその証明書に関連付け。

確認すべきは以下２点のどちらか

デジタル証明書のSANのFQDNと、実際にアクセスしているFQDNが整合？

デジタル証明書とsubjectに記載されているFQDNと、実際にアクセスしているFQDNが整合？


__FQDN__

```
日本語で完全修飾ドメイン名。ホスト名＋ドメイン名で表現される
```

#### 常時SSLと内容の検査
すべてのページをSSL/TLS対応とする常時SSL化が一般化
この時に問題となるのはUTMによる通信内容のチェック。暗号化されているため、そのままではウイルスチェックができなくなってしまう。
このため、実装されているのがSSLインスペクション

__SSLインスペクション__
暗号化されたデータを、UTMなどの機器が仲介して、内容の復号化を行い、内容のチェックを行う方法
復号化のポイントは2点
- UTMが自身のデジタル証明書を作成して、端末側の検証でパスすること
- UTMのデジタル証明書をブラウザの信頼されたルート証明書として登録しておくこと
→自作したデジタル証明書で信頼させることになるので、オレオレ証明書と呼ばれる
※手口は中間者攻撃と同様
※通信の仲介をするが、復号化、他方の暗号化が必要となり、負荷がかかる。処理を高速に行うために、専用のデバイスを搭載する。この専用デバイスをSSLアクセラレータ。処理をSSLアクセラレーションと呼ぶ。

## TLS(SSL)
PKIを活用した、ブラウザとWEBサーバとの通信を暗号化するプロトコルがTLS。
SSLが出てから、改版をされてTLSとなった。



