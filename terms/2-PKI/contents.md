## ディジタル証明書

PKIとはPKを用いてデジタル署名の正当性を証明する基盤(システム)

RA・CA：ある意味公的な証明書の発行を行う機関
秘密鍵：秘密に保管しておく
デジタル署名：契約書に押印
デジタル証明書：デジタル署名の正当性を証明する役割

#### デジタル証明書

デジタル署名の正当性を証明するデジタル証明書
デジタル証明書の中に存在する情報

- 公開鍵
- 有効期限
- 証明書の正当性(認証局のデジタル証明書)
  表記のフォーマット：X.509
  X.509という言葉は一般的にはIETFのPKI(X.509)と証明書失効リストプロファイル（CRL）
  X.509形式は証明書、CRLのフォーマット

#### PKIの運用環境

3つの役割

- CA:デジタル証明書のお墨付きを与える信頼のおける第3者機関
- RA:利用者からデジタル証明書の登録を受け付けて承認や認可を行う機関
- IA:デジタル証明書の正当性をかくにんするAPPが直接やり取りを行う

## PKIの仕組み

#### デジタル証明書が発行されるまでの手順

1. 本人が公開鍵の鍵ペア生成
2. 秘密鍵は保管。公開鍵と登録申請書記載→RAに申請(CSRと呼ぶ)
3. RAはCSRを受け取ると内容を審査する
4. CAがデジタル証明書を発行

#### デジタル証明書の利用例

通信相手の正当性を検証する

1. 送信者は文章のハッシュ値を計算→メッセージダイジェストと呼ばれる
2. メッセージダイジェストを秘密鍵を用いて暗号化→デジタル署名
3. 送信メッセージに、CAより発行されたデジタル証明書を添付
4. 3と文章、デジタル署名を相手に送信する
5. 送信者は4の内容より、デジタル署名を検証し、CAの正当性を確認する
   1. CAの公開鍵を用いてCAのデジタル署名を復号→デジタル証明書のハッシュ値を算出
6. デジタル証明書の中にあるPKを用いて、主体のデジタル署名を元のメッセージダイジェストに戻す
7. 受信者は受信した文章とデジタル署名を用いて、相手の正当性を確認する
8. 復号した送信メッセージダイジェストと、作成した作成メッセージダイジェストを比較する

CSR:デジタル証明書を取得するためのCAに対する申請書

CPS:認証局運用規定のこと。CA側でCPを作成して管理して、公開する。

#### デジタル証明書のチェック方法

取得したデジタル証明書のチェックする内容について説明する。

1. デジタル署名の検証
2. 有効期限の検証
3. 失効情報のチェック
4. ルート認証局、ルート証明書の検証
5. 証明書のレベルチェック
6. アクセス先のチェック

__失効情報のチェック__

有効期限が残っているのに強制的に執行することがある

CRLを確認する方法と、OCSPを確認する方法がある

__ルート認証局、ルート証明書の検証__

ルート認証局が信頼してよいCAかどうかを確認する

※ルート認証局は誰でも立ち上げることが出来るため。自組織で信頼してよいかが判断されたCAかをチェックする必要がある

巷で使われるブラウザにはデフォルトで信頼されたルート認証機関がインストールされていて、ここにない認証局が発行したデジタル証明書であることが確認されると”信頼されていない”

__証明書のレベル__

発行時の確認内容や審査内容の厳格さにより以下の３種類に分けられる

DV: ドメインだけを確認

OV: 企業や組織の実在性を確認

EV: OVよりも厳しく内容を確認

__アクセス先のチェック__

デジタル証明書を検証する場合、アクセス先のサーバがデジタル証明書に記載されたものと同じかをチェックして確認。確認するのは以下の２つ

| デジタル証明書                           | アクセス先 |
| ---------------------------------------- | ---------- |
| subejectAltName(SAN)に記載されているFQDN | FQDN       |
| subjectに記載されているFQDN              | FQDN       |

__SAN__

サーバー証明書のSubjectAltNameフィールド。

SANには、そのサーバー証明書を設定・使用するサーバーを示すドメイン名・IPアドレス・URIなどを記述し、それらの識別子（ID）をその証明書に関連付け。

確認すべきは以下２点のどちらか

デジタル証明書のSANのFQDNと、実際にアクセスしているFQDNが整合？

デジタル証明書とsubjectに記載されているFQDNと、実際にアクセスしているFQDNが整合？

__FQDN__

```
日本語で完全修飾ドメイン名。ホスト名＋ドメイン名で表現される
```

#### 常時SSLと内容の検査

すべてのページをSSL/TLS対応とする常時SSL化が一般化
この時に問題となるのはUTMによる通信内容のチェック。暗号化されているため、そのままではウイルスチェックができなくなってしまう。
このため、実装されているのがSSLインスペクション

__SSLインスペクション__
暗号化されたデータを、UTMなどの機器が仲介して、内容の復号化を行い、内容のチェックを行う方法
復号化のポイントは2点

- UTMが自身のデジタル証明書を作成して、端末側の検証でパスすること
- UTMのデジタル証明書をブラウザの信頼されたルート証明書として登録しておくこと
  →自作したデジタル証明書で信頼させることになるので、オレオレ証明書と呼ばれる
  ※手口は中間者攻撃と同様
  ※通信の仲介をするが、復号化、他方の暗号化が必要となり、負荷がかかる。処理を高速に行うために、専用のデバイスを搭載する。この専用デバイスをSSLアクセラレータ。処理をSSLアクセラレーションと呼ぶ。

## TLS(SSL)

PKIを活用した、ブラウザとWEBサーバとの通信を暗号化するプロトコルがTLS。
SSLが出てから、改版をされてTLSとなった。

TLSはSSL3.0を、IETFが改修して開発された。BEAST攻撃を回避するため、暗号化を大幅に強化した

#### 通信シーケンス

ハンドシェイクにより通信を行う

step1. Hello Requestの交換。クライアント側から利用可能な暗号アルゴリズムや圧縮方式を通知→サーバーで組み合わせを選択

step2. サーバーからクライアントへのメッセージ送信のフェーズ。サーバーからクライアントに対して、サーバのデジタル証明書を送付する。

step3. クライアントがサーバーからのデジタル証明書を検証→サーバーの正当性を確認する

step4. step3で正当だった場合。サーバーの公開鍵を用いて、クライアントが生成したプレマスタシークレットをサーバーに送信する(Client Key Exchange)。一通りメッセージ送信するとChange Cipher Specを送信して、暗号通信の開始を宣言する。

step5. サーバーもCHange Cipher Specを送信して、双方向の暗号通信が開始する。

#### SNI

SSL/TLSの拡張仕様の一つにSNIが存在(RFC6066)

従来は１台のサーバで一つのデジタル証明書しか持つことが出来なかったが、SNIを用いることで、複数のデジタル証明書をつかうことが出来るようになる。

ハンドシェイク時に、クライアント側がアクセスしたいFQDNを伝える。サーバーはFQDNに対応するデジタル証明書を返すという形で実現する。→サーバーとクライアント両方がSNIに対応している必要がある。

ハンドシェイク時のホスト名は平文だが、暗号化したESNIが存在する

#### SSL/TLSの脆弱性と攻撃

__ダウンロード攻撃__

SSL/TLSの暗号化スイートを決める際に、暗号化の弱いスイートを強制して、解読しやすい暗号通信を行う攻撃

__バージョンロールバック__

SSLのバージョンロールバック攻撃。SSL2.0のような古いバージョンを促して、解読しやすい暗号化通信を行う攻撃

__BEAST 攻撃__

SSL3.0/TLS1.0のCBCモードの脆弱性を利用して選択平文攻撃を行い、Cookieを得る攻撃。

Cookieの中の認証情報を取得して、通信に悪用するような可能性が考えられる。

__POODLE攻撃__

SSL3.0にあるブロック暗号上のパディングに関する設計上の脆弱性をついた攻撃。パディングを悪用して暗号通信を解読する。対策としては、SSL3.0を無効化すること。


##### CBCモード

CBCモード（Cipher Block Chainingモード）は、暗号化モードの一つで、ブロック暗号の運用モードの一種です。このモードでは、各ブロックの暗号化に前のブロックの暗号文を使用します。具体的には、次のように動作します2:

1. 最初の平文ブロックと初期化ベクトル（IV）をXOR演算します。
2. その結果を暗号化アルゴリズムに入力し、暗号文ブロックを生成します。
3. 次の平文ブロックと前の暗号文ブロックをXOR演算し、その結果を再び暗号化アルゴリズムに入力します。
4. このプロセスを繰り返して、全てのブロックを暗号化します。

CBCモードの特徴は、同じ平文ブロックが繰り返されても異なる暗号文ブロックが生成されるため、セキュリティが向上する点です

CBCモードは共通暗号化の１種。

##### 利用可能なアルゴリズム例


* **共通鍵暗号（対称鍵暗号）** :
* **AES（Advanced Encryption Standard）** : AES-GCM、AES-CCMなどがあり、TLS 1.3では特にAES-GCMが広く使用されています2。
* **ChaCha20** : Poly1305と組み合わせて使用され、TLS 1.3で標準として採用されています。
* **公開鍵暗号（非対称鍵暗号）** :
* **RSA** : 鍵交換やデジタル署名に使用されますが、TLS 1.3ではセキュリティ向上のため、使用が減少しています。
* **ECDHE（Elliptic Curve Diffie-Hellman Ephemeral）** : 鍵交換に使用され、TLS 1.3で推奨されています。
* **ハッシュ関数** :
* **SHA-256** : メッセージ認証コード（MAC）やデジタル署名に使用されます。
* **SHA-384** : 同様に、メッセージ認証コードやデジタル署名に使用されます

## HSTS(HttpStrict Transport Security)

WEBサイトがアクセスするブラウザに対して、HTTPSの通信を強制する機能。

ただし、始めてアクセスした場合はhttpでもアクセス可能。ここで中間者攻撃を受ける可能性がある。


## デジタル証明書の利用シチュエーション

デジタル証明書を利用するシチュエーションは以下の通り

| 証明書の種類           | 用途                                                                                                   |
| ---------------------- | ------------------------------------------------------------------------------------------------------ |
| サーバー証明書         | WEBサーバの正当性を証明するために利用されるときのデジタル証明書                                        |
| クライアント証明書     | クライアントの正当性を証明するために利用されるデジタル証明書                                           |
| S/MIME証明書           | 電子メールにデジタル証明書と暗号化を行い、メール送信者の身元証明と改ざん検知を行う                     |
| コードサイニング証明書 | SWの正当性を証明するデジタル証明書。<br />SWの配布元を認証し、改ざん検知やなりすましの検知を可能にする |


## 時刻認証

電子データにタイムスタンプを付与することで以下２点を証明する技術

* 存在性証明
  タイムスタンプ時に、電子データが存在すること
* 完全性証明
  タイムスタンプ時以降に、電子データが改ざんされていないこと


#### タイムビジネス認定制度

信頼のおける時刻情報を提供するための機関

* TSA
  タイムスタンプを発行したり、有効性を証明する機関
* TAA
  TSAに正確な時刻を配信する機関
